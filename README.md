# Carrot Market Reloaded

# 1 â¤ï¸ ANNOUNCEMENT

## 1.1 ğŸš¨ Read this First ğŸš¨

## 1.2 Thank You!

## 1.3 ğŸ”” NextJS Quiz ğŸ””

https://docs.google.com/forms/d/e/1FAIpQLSee9TXmr6qVsCMlrgO2lj0paJ5pXNKH9NSsPhZmah5d-VxmCA/viewscore?pli=1&viewscore=AE0zAgCMEFnFg55ttlgwlehrRNDYDg9RqoxZfTXiJF0yciQ1iOoxLg-NcJGTyRPn3Vtwwoc

# 2 INTRODUCTION

2ì›” 6ì¼ ê°•ì˜ ë…¹í™” ì‹œì‘

## 2.0 Welcome

ìœ ì €ì—ê²Œ ì‹¤ì œë¡œ ì–´ë–»ê²Œ ë³´ì¼ì§€ ë§Œë“¤ì–´ë³´ëŠ” ê°•ì˜

í† ì´ í”„ë¡œì íŠ¸ ë§ê³ , ì‹¤ì œ ì œí’ˆì„ ë§Œë“¤ì–´ë³´ë©´ ë” ë°°ìš°ëŠ”ê²Œ ë§ì•„ìš”. ê·¸ë¦¬ê³  í”„ë ˆì„ì›Œí¬ê°€ ì´ëŸ° ê¸°ëŠ¥ì„ ì™œ ì œê³µí•˜ëŠ”ì§€ë„ ì•Œ ìˆ˜ ìˆê²Œ ë˜ìš”.

Next.jsë„ ë¶ˆí¸í•œ ê²ƒì´ ìˆì–´ì„œ ì´ê±¸ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•´ì„œ í•´ê²°í•´ ë³´ê¸°ë„ í• ê±°ì—ìš”.

ë¬´ì—‡ì´ë“  êµ¬í˜„í•  ìˆ˜ ìˆë‹¤ëŠ” ìì‹ ê°!

## 2.1 Requirements

https://nomadocders.co/nextjs-for-beginners/

## 2.2 What Are We Using

- Next.js
- Prisma
- PlanetScale
- Vercel
- Cloudflare
  - Cloudflare Images
  - Cloudflare stream
  - Cloudflare workers

## 2.3 Learning Rate

ë°°ìš°ëŠ” ì‹œê°„ì€ ì„ í˜•ì…ë‹ˆë‹¤.

ì¸ì¦, ì´ë¯¸ì§€ê¹Œì§€ëŠ” ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. ê·¸ ì´í›„ëŠ” ì­‰ì­‰ ë‚˜ê°ˆê²ë‹ˆë‹¤.

## 2.4 How To Get Help

1. ëŒ“ê¸€
   1. ì‘ë™, ê°œë… ì§ˆë¬¸
2. Issues
   1. ë­”ê°€ ì´ìƒí•¨, ì—ëŸ¬2

## 2.5 Project Setup

Git Providerë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” GitHub ì‚¬ìš©!

https://nextjs.org/docs/app/api-reference/create-next-app

https://nextjs.org/docs/pages/api-reference/create-next-app

```bash
npx create-next-app@latest
```

TypeScriptë¥¼ ì”ì‹œë‹¤!

```
Yes Yes Yes No Yes No
```

# 3 TAILWIND

## 3.0 Introduction

ë””ìì´ë„ˆ ì—†ì´ ë©‹ì§„ CSSë¥¼ ë¹ ë¥´ê²Œ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´ CSS Frameworkë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ ì¤‘ ë©‹ì§€ê³  ë©‹ì§„ Tailwind CSSë¥¼ ë°°ì›Œë´…ì‹œë‹¤.

Utility FirstëŠ” ì§§ì€ class nameì´ ì—„ì²­ ë§ë‹¤.

Bootstrap, Foundationì€ ê¸°ë³¸ì ì¸ UIë¥¼ ì œê³µí•´ì„œ ë¹„ìŠ·ë¹„ìŠ·í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ Tailwind CSSëŠ” ì•„ë¬´ê²ƒë„ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì§ì ‘ classë¥¼ ë§Œë“¤ë ¤ë¨¼ class ì´ë¦„ë„ ê³ ë¯¼í•´ì•¼í•˜ê³ , ê°’ë„ ê³ ë¯¼í•´ì•¼ í•©ë‹ˆë‹¤.

Tailwind CSSë¥¼ ì§ì ‘ ë§Œë“  ì‚¬ëŒë„, CSSì™€ Markupì„ ì„ë‹¤ë‹ˆ!!! ë‚œë¦¬ë‚  ê²ƒì„ ì•Œì•˜ì§€ë§Œ, ê·¸ë˜ë„ í•œ ë²ˆ ì¨ë³´ë¼ê³  í–ˆë‹¤.

ë°˜ì‘í˜•, ë‹¤í¬ëª¨ë“œ ë“±ë“± ë‹¤ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ë§ì€ íšŒì‚¬ë“¤ì—ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

## 3.1 IntelliSense

ê°„ë‹¨í•œ ê²ƒë“¤ ë§Œë“¤ì–´ë´…ì‹œë‹¤.

Visual Studio Code Extension, Tailwind CSS IntelliSense ì„¤ì¹˜

ê·¸ëŸ¬ë©´ ì´ Extensionì´ tailwind.config.tsë¥¼ í™•ì¸

Auto complete: option + esc

## 3.2 Card Component

1 container + 4 row + each column

```tsx
export default function Home() {
  return (
    <main>
      <div>
        <div>
          <div>
            <span>In transit</span>
            <span>Coolblue</span>
          </div>
          <div />
        </div>
        <div>
          <span>Time</span>
          <span>9:30-10:30</span>
        </div>
        <div>
          <div />
          <div />
        </div>
        <div>
          <span>Expected</span>
          <span>Sorting center</span>
          <span>In transit</span>
          <span>Delivered</span>
        </div>
      </div>
    </main>
  );
}
```

ì‘ì—… í›„

```tsx
export default function Home() {
  return (
    <main className="bg-gray-300 h-screen flex items-center justify-center p-5">
      <div className="bg-white shadow-lg p-5 rounded-2xl w-full">
        <div className="flex justify-between items-center">
          <div className="flex flex-col">
            <span className="text-gray-600 font-semibold -mb-1">
              In transit
            </span>
            <span className="text-4xl font-semibold">Coolblue</span>
          </div>
          <div className="size-12 rounded-full bg-orange-400" />
        </div>
        <div className="my-2 flex items-center gap-2">
          <span className="bg-green-400 text-white uppercase px-2.5 py-1.5 text-xs font-medium rounded-full ">
            Today
          </span>
          <span>9:30-10:30</span>
        </div>
        <div className="relative">
          <div className="bg-gray-200 absolute rounded-full w-full h-2" />
          <div className="bg-green-400 absolute rounded-full w-2/3 h-2" />
        </div>
        <div className="flex justify-between items-center mt-5 text-gray-600">
          <span>Expected</span>
          <span>Sorting center</span>
          <span>In transit</span>
          <span className="text-gray-400">Delivered</span>
        </div>
      </div>
    </main>
  );
}
```

## 3.3 Modifiers

modifierëŠ” Styleì„ ì¡°ê±´ë¶€ë¡œ ì ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ

modifierëŠ” ì‹œì‘ì„ í•­ìƒ : ìœ¼ë¡œ í•©ë‹ˆë‹¤.

Dark Mode

hover over

```tsx
export default function Home() {
  return (
    <main className="bg-gray-100 h-screen flex items-center justify-center p-5 dark:bg-gray-700">
      <div className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm dark:bg-gray-600">
        <div className="flex justify-between items-center">
          <div className="flex flex-col">
            <span className="text-gray-600 font-semibold -mb-1 dark:text-gray-300">
              In transit
            </span>
            <span className="text-4xl font-semibold dark:text-white">
              Coolblue
            </span>
          </div>
          <div className="size-12 rounded-full bg-orange-400" />
        </div>
        <div className="my-2 flex items-center gap-2">
          <span className="bg-green-400 text-white uppercase px-2.5 py-1.5 text-xs font-medium rounded-full transition hover:bg-green-500 hover:scale-125">
            Today
          </span>
          <span className="dark:text-gray-100">9:30-10:30</span>
        </div>
        <div className="relative">
          <div className="bg-gray-200 absolute rounded-full w-full h-2" />
          <div className="bg-green-400 absolute rounded-full w-2/3 h-2" />
        </div>
        <div className="flex justify-between items-center mt-5 text-gray-600 dark:text-gray-300 ">
          <span>Expected</span>
          <span>Sorting center</span>
          <span>In transit</span>
          <span className="text-gray-400 dark:text-gray-500">Delivered</span>
        </div>
      </div>
    </main>
  );
}
```

## 3.4 Tailwind Variables

ring, â€”tw-ring-offset-shadow, â€”tw-ring-shadow

ê°€ë” ringì²˜ëŸ¼ ì—¬ëŸ¬ ë³€ìˆ˜ë¥¼ í•„ìš”ë¡œí•˜ëŠ” ì†ì„±ì„ ë§Œë‚˜ê²Œ ë  ê±°ì—ìš”.

bg-blackì—ëŠ” â€”tw-bg-opacityê°€ ìˆëŠ”ë°ìš” bg-opacityë¥¼ ì„¤ì •í•˜ë©´ CSSëŠ” ë°”ê¾¸ì§€ ì•Šì§€ë§Œ ë³€ìˆ˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
export default function Home() {
  return (
    <main className="bg-gray-100 h-screen flex items-center justify-center p-5">
      <div className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm flex flex-col gap-2">
        <input
          className="w-full rounded-full h-10 bg-gray-200 pl-5 focus:outline-none ring ring-transparent focus:ring-orange-500 focus:ring-offset-2 transition-shadow placeholder:text-red-600 placeholder:drop-shadow"
          type="text"
          placeholder="Search here..."
        />
        <button className="bg-black text-white py-2 rounded-full active:scale-90 transition-transform font-medium  outline-none">
          Search
        </button>
      </div>
    </main>
  );
}
```

## 3.5 Responsive Modifiers

ë‹¤í¬ëª¨ë“œ ë”¸ê¹

Tailwind CSSëŠ” ëª¨ë°”ì¼ì´ ìš°ì„ ì´ë‹¤. ê·¸ë˜ì„œ ë” í° í™”ë©´ì— ì‚¬ìš©í•˜ëŠ” modifierê°€ ì¡´ì¬.

Tailwindì—ì„œëŠ” ë°˜ëŒ€ë¡œ ëª¨ë°”ì¼ë¶€í„° í•˜ê³  ë°ìŠ¤í¬íƒ‘ì„ ê¾¸ë°‰ë‹ˆë‹¤.

https://tailwindcss.com/docs/containerì— sm, md, lg, xl, 2xlì— ëŒ€í•œ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤.

```tsx
export default function Home() {
  return (
    <main className="bg-gray-100 sm:bg-red-100 md:bg-green-100 lg:bg-cyan-100 xl:bg-orange-100 2xl:bg-purple-100 h-screen flex items-center justify-center p-5">
      <div className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm flex flex-col md:flex-row gap-2">
        <input
          className="w-full rounded-full h-10 bg-gray-200 pl-5 outline-none ring ring-transparent focus:ring-orange-500 focus:ring-offset-2 transition-shadow placeholder:drop-shadow"
          type="text"
          placeholder="Search here..."
        />
        <button className="bg-black text-white py-2 rounded-full active:scale-90  transition-transform font-medium outline-none md:px-10 ">
          Search
        </button>
      </div>
    </main>
  );
}
```

## 3.6 Form Modifiers

- bg-gradient-to-tr from-cyan-500 to-purple-400
- https://tailwindcss.com/docs/gradient-color-stops
- invalid:
- https://tailwindcss.com/docs/hover-focus-and-other-states#invalid
- invalid:form: ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- peerëŠ” ë¶€ëª¨ì— ì„ ì–¸, ìì‹ì—ì„œ ì„¤ì •
- https://tailwindcss.com/docs/hover-focus-and-other-states#styling-based-on-sibling-state
- hidden
  - display: none

```tsx
export default function Home() {
  return (
    <main className="bg-gray-100 sm:bg-red-100 md:bg-green-100 lg:bg-cyan-100 xl:bg-orange-100 2xl:bg-purple-100 h-screen flex items-center justify-center p-5">
      <div className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm flex flex-col md:flex-row gap-2">
        <input
          className="w-full rounded-full h-10 bg-gray-200 pl-5 outline-none ring ring-transparent focus:ring-green-500 focus:ring-offset-2 transition-shadow placeholder:drop-shadow invalid:focus:ring-red-500 peer"
          type="email"
          required
          placeholder="Email address"
        />
        <span className="text-red-500 font-medium hidden peer-invalid:block ">
          Email is required.
        </span>
        <button className="text-white py-2 rounded-full active:scale-90  transition-transform font-medium outline-none md:px-10 bg-black ">
          Log in
        </button>
      </div>
    </main>
  );
}
```

## 3.7 State Modifiers

\*: outline-none â†’ ìì‹ì— ëª¨ë‘ ì ìš©!

https://tailwindcss.com/docs/hover-focus-and-other-states#styling-direct-children

has-[.peer]:bg-green-100 â†’

https://tailwindcss.com/docs/hover-focus-and-other-states#styling-based-on-descendants

hasëŠ” CSSì˜ ê°€ìƒ í´ë˜ìŠ¤

```tsx
export default function Home() {
  return (
    <main className="bg-gray-100 sm:bg-red-100 md:bg-green-100 lg:bg-cyan-100 xl:bg-orange-100 2xl:bg-purple-100 h-screen flex items-center justify-center p-5">
      <div
        className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm flex flex-col md:flex-row gap-2 *:outline-none ring ring-transparent transition-shadow
      has-[:invalid]:ring-red-100"
      >
        <input
          className="w-full rounded-full h-10 bg-gray-200 pl-5 ring ring-transparent focus:ring-green-500 focus:ring-offset-2 transition-shadow placeholder:drop-shadow invalid:focus:ring-red-500 peer"
          type="text"
          required
          placeholder="Email address"
        />
        <span className="text-red-500 font-medium hidden peer-invalid:block ">
          Email is required.
        </span>
        <button className="text-white py-2 rounded-full active:scale-90  transition-transform font-medium  md:px-10 bg-black ">
          Log in
        </button>
      </div>
    </main>
  );
}
```

## 3.8 Lists and Animations

- odd:
- even:
- first:
- last:
- animation-bounce
- animation-spin ë¡œë”©ì— ì‚¬ìš©ë¨
- animation-pulse ë¡œë”©ì— ì‚¬ìš©ë¨, ìŠ¤ì¼ˆë ˆí†¤ + double background
- empty:

```
export default function Home() {
  return (
    <main className="bg-gray-100 sm:bg-red-100 md:bg-green-100 lg:bg-cyan-100 xl:bg-orange-100 2xl:bg-purple-100 h-screen flex items-center justify-center p-5">
      <div className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm flex flex-col gap-4">
        {["Nico", "Me", "You", "Yourself", ""].map((person, index) => (
          <div key={index} className="flex items-center gap-5">
            <div className="size-10 bg-blue-400 rounded-full" />
            <span className="text-lg font-medium empty:w-24 empty:h-5 empty:rounded-full empty:animate-pulse empty:bg-gray-300">
              {person}
            </span>
            <div className="size-6 bg-red-500 text-white flex items-center justify-center rounded-full relative">
              <span className="z-10">{index}</span>
              <div className="size-6 bg-red-500 rounded-full absolute animate-ping " />
            </div>
          </div>
        ))}
      </div>
    </main>
  );
}

```

## 3.9 Group Modifiers

ì§€ê¸ˆê¹Œì§€ëŠ” ìì‹ì˜ ìƒíƒœê°€ ë°”ë€Œë©´ ë¶€ëª¨ ì»¨í…Œì´ë„ˆë¥¼ ë°”ê¾¸ëŠ” ê±¸ ë°°ì›Œë´¤ìŠµë‹ˆë‹¤.

ì´ì   ë¶€ëª¨ì˜ stateê°€ ë°”ë€Œì—ˆì„ ë•Œ!!! ìì‹ì„ ë°”ê¾¸ê²Œ í•˜ëŠ”ê²Œ Group modifier

```tsx
<div className="group">
  <div className="group-hover: text-red-500"></div>
</div>
```

- group-hover
- group-require
- group-focus
- group-invalid

```tsx
export default function Home() {
  return (
    <main className="bg-gray-100 sm:bg-red-100 md:bg-green-100 lg:bg-cyan-100 xl:bg-orange-100 2xl:bg-purple-100 h-screen flex items-center justify-center p-5">
      <div className="bg-white shadow-lg p-5 rounded-3xl w-full max-w-screen-sm flex flex-col gap-4">
        <div className="group flex flex-col">
          <input
            className="bg-gray-100 w-full"
            placeholder="Write your email"
          />
          <span className="group-focus-within:block hidden">
            Make sure it is a valid email...
          </span>
          <button>Submit</button>
        </div>
      </div>
    </main>
  );
}
```

## 3.10 JIT

Tailwind CSSê°€ ìˆ˜ë§Œê°€ì§€ CSS classë¥¼ ì¤€ë¹„í•´ ë‘” ê²ƒì´ ì•„ë‹ˆë¼, ìœ ì €ê°€ classNameì„ ì‘ì„±í•˜ë©´ ê±°ê¸°ì— ë§ê²Œ CSSë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤.

JIT compilerì…ë‹ˆë‹¤.

arbitrary values, ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” ì• ë§¤í•œ ê°’ ì¶”ê°€í•  ë•Œ

```tsx
<div className="h-10" />
<div className="h-[3523.23px]" />
```

ì›í•˜ëŠ” ìƒ‰ìƒ ì¶”ê°€

https://tailwindcss.com/docs/adding-custom-styles

```tsx
<button className="rounded-sexy-name mt-tomato">Submit</button>
```

```tsx
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      margin: {
        tomato: "120px",
      },
      borderRadius: {
        "sexy-name": "11.11px",
      },
    },
  },
  plugins: [],
};
export default config;
```

## 3.11 Directives

https://tailwindcss.com/docs/functions-and-directives

ìš°ë¦¬ê°€ classNameì— ì¶”ê°€í•œ CSSëŠ” utilities

baseëŠ” resetê³¼ ë¹„ìŠ·

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

componentëŠ”??

@applyëŠ”?? ë¶„ë¦¬ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ ìœ„í•œ ê²ƒ.

```css
.btn {
  @apply w-full bg-black;
}
```

```html
<div className="btn" />
```

@layerëŠ” baseì— ì¶”ê°€í• ë•Œ ì‚¬ìš©

```html
@layer base { a { @apply text-blue-500; } }
```

@tailwind componentëŠ”???

layer, base ë“± baseë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•´ layerì™€ applyë¥¼ í•œ ê²ƒë“¤ì„ baseëŠ” ë‚´ë²„ë ¤ë‘ê³  componentì—ì„œ í•´ë¼~~

## 3.12 Plugins

componentëŠ” pluginì„ ìœ„í•œ ê²ƒ

npmìœ¼ë¡œ ë‚¨ë“¤ì´ ë§Œë“  pluginì„ ë°›ì•„ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

ex) daisyUI, tailwind CSS Form

## 3.13 Conclusions

ì•ìœ¼ë¡œ ë§Œë“¤ì–´ê°€ë©´ì„œ ë§ì´ ì‚¬ìš©í• ê±°ë¼ ê¸ˆë°© ìµìˆ™í•´ì§ˆ ê²ë‹ˆë‹¤.

# 4 AUTHENTICATION UI

## 4.0 Home Screen

- ë¡œê·¸ì•„ì›ƒ í–ˆì„ ë•Œ í˜ì´ì§€
- ë¡œê·¸ì¸ í˜ì´ì§€
- íšŒì›ê°€ì… í˜ì´ì§€
- SMS ì¸ì¦ ë¡œê·¸ì¸ í˜ì´ì§€

ë§Œë“¤ê²ë‹ˆë‹¤.

ë‹¤í¬ëª¨ë“œë§Œ í•  ê²ë‹ˆë‹¤.

ë°˜ì‘í˜• ë§ì´ ì•ˆí• ê²ë‹ˆë‹¤.

ì œì¼ ë¨¼ì € í™ˆí˜ì´ì§€ë¶€í„° ë§Œë“­ì‹œë‹¤.

- Tailwind CSS
  - underline-offset-4
  - \*:
  - my-auto, mx-auto

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  a {
    @apply text-orange-500;
  }
}
```

```tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${inter.className} bg-neutral-900 text-white max-w-screen-sm mx-auto`}
      >
        {children}
      </body>
    </html>
  );
}
```

```tsx
import Link from "next/link";

export default function Home() {
  return (
    <div className="flex flex-col items-center justify-between min-h-screen p-6">
      <div className="my-auto flex flex-col items-center gap-2 *:font-medium">
        <span className="text-9xl">ğŸ¥•</span>
        <h1 className="text-4xl ">ë‹¹ê·¼</h1>
        <h2 className="text-2xl">ë‹¹ê·¼ ë§ˆê²Ÿì— ì–´ì„œì˜¤ì„¸ìš”!</h2>
      </div>
      <div className="flex flex-col items-center gap-3 w-full">
        <Link
          href="/create-account"
          className="w-full bg-orange-500 text-white text-lg font-medium py-2.5 rounded-md text-center hover:bg-orange-400 transition-colors"
        >
          ì‹œì‘í•˜ê¸°
        </Link>
        <div className="flex gap-2">
          <span>ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”?</span>
          <Link href="/login" className="hover:underline">
            ë¡œê·¸ì¸
          </Link>
        </div>
      </div>
    </div>
  );
}
```

## 4.1 Create Account Screen

íšŒì› ê°€ì… í˜ì´ì§€ ë§Œë“­ì‹œë‹¤.

- ì¸ì‚¬ë§
- formì„ ì‚¬ìš©í•œ ê°€ì…
- SMS ê°€ì…

Tailwind CSS

- ring-1
- ring-2

êµµê¸°ì°¨ì´ ì…ë‹ˆë‹¤.

ê³µí†µ ë¶€ë¶„ componentë¡œ ì˜®ê¸°ê¸°

```css
@layer components {
  .primary-btn {
    @apply w-full bg-orange-500 text-white  font-medium  rounded-md text-center hover:bg-orange-400 transition-colors;
  }
}
```

h-1pxì€ ì—†ê³  h-pxëŠ” ìˆìŠµë‹ˆë‹¤.

```tsx
import { ChatBubbleOvalLeftEllipsisIcon } from "@heroicons/react/24/solid";
import Link from "next/link";

export default function CreateAccount() {
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Fill in the form below to join!</h2>
      </div>
      <form className="flex flex-col gap-3">
        <div className="flex flex-col gap-2">
          <input
            className="bg-transparent rounded-md w-full h-10 focus:outline-none ring-1 focus:ring-2 ring-neutral-200 focus:ring-orange-500 border-none placeholder:text-neutral-400"
            type="text"
            placeholder="Username"
            required
          />
          <span className="text-red-500 font-medium">Input error</span>
        </div>
        <button className="primary-btn h-10">Create account</button>
      </form>
      <div className="w-full h-px bg-neutral-500" />
      <div>
        <Link
          className="primary-btn flex h-10 items-center justify-center gap-2"
          href="/sms"
        >
          <span>
            <ChatBubbleOvalLeftEllipsisIcon className="h-6 w-6" />
          </span>
          <span>Sign up with SMS</span>
        </Link>
      </div>
    </div>
  );
}
```

ì•„ì´ì½˜ë„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

@heroicons/react

https://github.com/tailwindlabs/heroicons

## 4.2 Form Components

typeì´ í•„ìš”í•˜ê¸° ì „ê¹Œì§€ interface ì“°ì„¸ìš”.

- disabled:bg-neutral-400
- disabled:text-neutral-300
- disabled:cursor-not-allowed

ì§€ê¸ˆê¹Œì§€ JavaScript ì‚¬ìš©í•œê±° ì—†ìŠµë‹ˆë‹¤~~

- app/create-account/page.tsx

```tsx
import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";

export default function CreateAccount() {
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Fill in the form below to join!</h2>
      </div>
      <form className="flex flex-col gap-3">
        <FormInput type="text" placeholder="Username" required errors={[]} />
        <FormInput type="email" placeholder="Email" required errors={[]} />
        <FormInput
          type="password"
          placeholder="Password"
          required
          errors={[]}
        />
        <FormInput
          type="password"
          placeholder="Confirm Password"
          required
          errors={[]}
        />
        <FormButton loading={false} text="Create account" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

- components/form-btn.tsx

```tsx
interface FormButtonProps {
  loading: boolean;
  text: string;
}

export default function FormButton({ loading, text }: FormButtonProps) {
  return (
    <button
      disabled={loading}
      className="primary-btn h-10 disabled:bg-neutral-400  disabled:text-neutral-300 disabled:cursor-not-allowed"
    >
      {loading ? "ë¡œë”© ì¤‘" : text}
    </button>
  );
}
```

- components/form-login.tsx

```tsx
interface FormInputProps {
  type: string;
  placeholder: string;
  required: boolean;
  errors: string[];
}

export default function FormInput({
  type,
  placeholder,
  required,
  errors,
}: FormInputProps) {
  return (
    <div className="flex flex-col gap-2">
      <input
        className="bg-transparent rounded-md w-full h-10 focus:outline-none ring-2 focus:ring-4 transition ring-neutral-200 focus:ring-orange-500 border-none placeholder:text-neutral-400"
        type={type}
        placeholder={placeholder}
        required={required}
      />
      {errors.map((error, index) => (
        <span key={index} className="text-red-500 font-medium">
          {error}
        </span>
      ))}
    </div>
  );
}
```

## 4.3 Log in Screen

import alias â†’ @/components/form-btn

```json
    "paths": {
      "@/*": [
        "./*"
      ]
    }
```

GitHub svg icon

- https://www.svgrepo.com/svg/512317/github-142
- https://react-icons.github.io/react-icons/search/#q=github
- https://icons8.com/icons/set/github

íšŒì›ê°€ì… í˜ì´ì§€ë¥¼ ë³µì‚¬í•´ì„œ /login, /smsë„ ë§Œë“¤ì–´ë´…ì‹œë‹¤.

CSSì— ìì‹ ê°ì„ ê°€ì§€ì„¸ìš”!!!

- app/login/page.tsx

```tsx
import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";

export default function LogIn() {
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Log in with email and password.</h2>
      </div>
      <form className="flex flex-col gap-3">
        <FormInput type="email" placeholder="Email" required errors={[]} />
        <FormInput
          type="password"
          placeholder="Password"
          required
          errors={[]}
        />
        <FormButton loading={false} text="Log in" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

- app/sms/page.tsx

```tsx
import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";

export default function SMSLogin() {
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">SMS Log in</h1>
        <h2 className="text-xl">Verify your phone number.</h2>
      </div>
      <form className="flex flex-col gap-3">
        <FormInput
          type="number"
          placeholder="Phone number"
          required
          errors={[]}
        />
        <FormInput
          type="number"
          placeholder="Verification code"
          required
          errors={[]}
        />
        <FormButton loading={false} text="Verify" />
      </form>
    </div>
  );
}
```

- components/social-login.tsx

```tsx
import { ChatBubbleOvalLeftEllipsisIcon } from "@heroicons/react/24/solid";
import Link from "next/link";

export default function SocialLogin() {
  return (
    <>
      <div className="w-full h-px bg-neutral-500" />
      <div className="flex flex-col gap-3">
        <Link
          className="primary-btn flex h-10 items-center justify-center gap-2"
          href="/github/start"
        >
          <svg
            className="size-6"
            viewBox="0 0 15 15"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M7.49933 0.25C3.49635 0.25 0.25 3.49593 0.25 7.50024C0.25 10.703 2.32715 13.4206 5.2081 14.3797C5.57084 14.446 5.70302 14.2222 5.70302 14.0299C5.70302 13.8576 5.69679 13.4019 5.69323 12.797C3.67661 13.235 3.25112 11.825 3.25112 11.825C2.92132 10.9874 2.44599 10.7644 2.44599 10.7644C1.78773 10.3149 2.49584 10.3238 2.49584 10.3238C3.22353 10.375 3.60629 11.0711 3.60629 11.0711C4.25298 12.1788 5.30335 11.8588 5.71638 11.6732C5.78225 11.205 5.96962 10.8854 6.17658 10.7043C4.56675 10.5209 2.87415 9.89918 2.87415 7.12104C2.87415 6.32925 3.15677 5.68257 3.62053 5.17563C3.54576 4.99226 3.29697 4.25521 3.69174 3.25691C3.69174 3.25691 4.30015 3.06196 5.68522 3.99973C6.26337 3.83906 6.8838 3.75895 7.50022 3.75583C8.1162 3.75895 8.73619 3.83906 9.31523 3.99973C10.6994 3.06196 11.3069 3.25691 11.3069 3.25691C11.7026 4.25521 11.4538 4.99226 11.3795 5.17563C11.8441 5.68257 12.1245 6.32925 12.1245 7.12104C12.1245 9.9063 10.4292 10.5192 8.81452 10.6985C9.07444 10.9224 9.30633 11.3648 9.30633 12.0413C9.30633 13.0102 9.29742 13.7922 9.29742 14.0299C9.29742 14.2239 9.42828 14.4496 9.79591 14.3788C12.6746 13.4179 14.75 10.7025 14.75 7.50024C14.75 3.49593 11.5036 0.25 7.49933 0.25Z"
              fill="currentColor"
              fillRule="evenodd"
              clipRule="evenodd"
            ></path>
          </svg>
          <span>Continue with Github</span>
        </Link>
        <Link
          className="primary-btn flex h-10 items-center justify-center gap-2"
          href="/sms"
        >
          <ChatBubbleOvalLeftEllipsisIcon className="size-6" />
          <span>Continue with SMS</span>
        </Link>
      </div>
    </>
  );
}
```

# 5 SERVER ACTIONS

## 5.0 Route Handlers

ë¡œê·¸ì¸í•  ë•Œ ì´ì „ê¹Œì§€ëŠ” ë°±ì—”ë“œ API /api/login ì„ ì´ìš©í•´ ë¡œê·¸ì¸í–ˆì—ˆìŠµë‹ˆë‹¤. ì§€ê¸ˆë„ ê°€ëŠ¥í•˜ê¸´ í•˜ì§€ë§Œ ë‹¤ë¥¸ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.

ì´ëŸ° ë°©ë²•ì„ API Routeë¼ê³  í•©ë‹ˆë‹¤. í´ë” ì´ë¦„ì€ ìƒê´€ ì—†ê³  route.tsê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.

route handler

ê·¸ë¦¬ê³  NextRequestê°€ ì¤‘ìš”í•©ë‹ˆë‹¤.

ì´ì œ API Routeë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.

- app/login/page.tsx

```tsx
"use client";

import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";

export default function LogIn() {
  const onClick = async () => {
    const response = await fetch("/www/users", {
      method: "POST",
      body: JSON.stringify({
        username: "nico",
        password: "1234",
      }),
    });
    console.log(await response.json());
  };
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Log in with email and password.</h2>
      </div>
      <form className="flex flex-col gap-3">
        <FormInput type="email" placeholder="Email" required errors={[]} />
        <FormInput
          type="password"
          placeholder="Password"
          required
          errors={[]}
        />
      </form>
      <span onClick={onClick}>
        <FormButton loading={false} text="Log in" />
      </span>
      <SocialLogin />
    </div>
  );
}
```

- www/users/route.tsx

```tsx
import { NextRequest } from "next/server";

export async function GET(request: NextRequest) {
  console.log(request);
  return Response.json({
    ok: true,
  });
}

export async function POST(request: NextRequest) {
  const data = await request.json();
  console.log("log the user in!!!");
  return Response.json(data);
}
```

## 5.1 Server Actions

formData: FormData!!!!

https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations

https://developer.mozilla.org/en-US/docs/Web/API/FormData#instance_methods

`â€œuse serverâ€` ëŠ” í•­ìƒ ìµœ ìƒë‹¨ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

`<input />` ì—ëŠ” nameì´ í•„ìš”í•©ë‹ˆë‹¤.

`formData.get(â€nameâ€)`

```tsx
async function handleForm(formData: FormData) {
  "use server";
}
```

- app/login/page.tsx

```tsx
import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";

export default function LogIn() {
  async function handleForm(formData: FormData) {
    "use server";
    console.log(formData.get("email"), formData.get("password"));
    console.log("i run in the server baby!");
  }
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Log in with email and password.</h2>
      </div>
      <form action={handleForm} className="flex flex-col gap-3">
        <FormInput
          name="email"
          type="email"
          placeholder="Email"
          required
          errors={[]}
        />
        <FormInput
          name="password"
          type="password"
          placeholder="Password"
          required
          errors={[]}
        />
        <FormButton loading={false} text="Log in" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

- components/form-input.tsx

```tsx
interface FormInputProps {
  type: string;
  placeholder: string;
  required: boolean;
  errors: string[];
  name: string;
}

export default function FormInput({
  type,
  placeholder,
  required,
  errors,
  name,
}: FormInputProps) {
  return (
    <div className="flex flex-col gap-2">
      <input
        name={name}
        className="bg-transparent rounded-md w-full h-10 focus:outline-none ring-2 focus:ring-4 transition ring-neutral-200 focus:ring-orange-500 border-none placeholder:text-neutral-400"
        type={type}
        placeholder={placeholder}
        required={required}
      />
      {errors.map((error, index) => (
        <span key={index} className="text-red-500 font-medium">
          {error}
        </span>
      ))}
    </div>
  );
}
```

## 5.2 useFormStatus

react-hook-form ì‚¬ìš© ì•ˆí•´ë„ ë¨.

useMutation hook ì•ˆí•´ë„ ë¨

ë¡œë”© ë§Œë“œëŠ”ë° í•„ìš”í•œ form status

```tsx
import { useFormStatus } from "react-dom;";
```

- components/form-btn.tsx

```tsx
"use client";

import { useFormStatus } from "react-dom";

interface FormButtonProps {
  text: string;
}

export default function FormButton({ text }: FormButtonProps) {
  const { pending } = useFormStatus();
  return (
    <button
      disabled={pending}
      className="primary-btn h-10 disabled:bg-neutral-400  disabled:text-neutral-300 disabled:cursor-not-allowed"
    >
      {pending ? "ë¡œë”© ì¤‘" : text}
    </button>
  );
}
```

- app/login/page.tsx

```tsx
import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";

export default function LogIn() {
  async function handleForm(formData: FormData) {
    "use server";
    await new Promise((resolve) => setTimeout(resolve, 5000));
    console.log("logged in!");
  }
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Log in with email and password.</h2>
      </div>
      <form action={handleForm} className="flex flex-col gap-3">
        <FormInput
          name="email"
          type="email"
          placeholder="Email"
          required
          errors={[]}
        />
        <FormInput
          name="password"
          type="password"
          placeholder="Password"
          required
          errors={[]}
        />
        <FormButton text="Log in" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

## 5.3 useFormState

- server actionê³¼ useFormState()ì˜ ì¡°í•©
- useActionState()ë¡œ ì´ë¦„ ë°”ë€œ

`const [state, formAction] = useActionState(fn, initialState, permalink?);`

ì´ê±° ì¢€ ì–´ë ¤ì›€.

- app/login/page.tsx

```tsx
"use client";

import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";
import { useFormState } from "react-dom";
import { handleForm } from "./actions";

export default function LogIn() {
  const [state, action] = useFormState(handleForm, null);
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Log in with email and password.</h2>
      </div>
      <form action={action} className="flex flex-col gap-3">
        <FormInput
          name="email"
          type="email"
          placeholder="Email"
          required
          errors={[]}
        />
        <FormInput
          name="password"
          type="password"
          placeholder="Password"
          required
          errors={state?.errors ?? []}
        />
        <FormButton text="Log in" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

- app/login/actions.tsx

```tsx
"use server";

export async function handleForm(prevState: any, formData: FormData) {
  console.log(prevState);
  await new Promise((resolve) => setTimeout(resolve, 5000));
  return {
    errors: ["wrong password", "password too short"],
  };
}
```

# 6 VALIDATION

## 6.0 Introduction to Zod

if, if, ifë¥¼ í”¼í•˜ê³  ì‹¶ì–´ìš”. ZodëŠ” ê·¸ê±¸ í•´ê²°í•´ì¤ë‹ˆë‹¤.

ìœ ì €ëŠ” ë¯¿ì„ ìˆ˜ ì—†ì–´ìš”!

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‘ì„±ëœ ì½”ë“œì˜ ì»´íŒŒì¼ ì‹œì ì—ë§Œ íƒ€ì… ê²€ì‚¬ë¥¼ í•˜ë©°, ì´ê²ƒì€ ì˜¤ì§ ê°œë°œìë¥¼ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.

ì»´íŒŒì¼ì„ í•œ í›„ ìë°”ìŠ¤í¬ë¦½íŠ¸ ëŸ°íƒ€ì„ í™˜ê²½ì—ì„œëŠ” íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ê°€ ì•„ë¬´ëŸ° í˜ì„ ì“°ì§€ ëª»í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ zod ì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë„ì›€ì„ ë°›ì•„ì„œ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ëŸ°íƒ€ì„ í™˜ê²½ì—ì„œë„ íƒ€ì… ê²€ì‚¬(ìœ íš¨ì„± ê²€ì¦)ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

https://www.daleseo.com/zod-why-validation/

```tsx
"use server";

import { z } from "zod";

const usernameSchema = z.string().min(5).max(10);

export async function createAccount(prevState: any, formData: FormData) {
  const data = {
    username: formData.get("username"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirm_password: formData.get("confirm_password"),
  };
  usernameSchema.parse(data.username);
}
```

```tsx
"use client";

import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";
import { useFormState } from "react-dom";
import { createAccount } from "./actions";

export default function CreateAccount() {
  const [state, dispatch] = useFormState(createAccount, null);
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Fill in the form below to join!</h2>
      </div>
      <form action={dispatch} className="flex flex-col gap-3">
        <FormInput
          name="username"
          type="text"
          placeholder="Username"
          required
        />
        <FormInput name="email" type="email" placeholder="Email" required />
        <FormInput
          name="password"
          type="password"
          placeholder="Password"
          required
        />
        <FormInput
          name="confirm_password"
          type="password"
          placeholder="Confirm Password"
          required
        />
        <FormButton text="Create account" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

## 6.1 Validation Errors

[Object Schema]

z.object() ë¡œ ì˜¤ë¸Œì íŠ¸ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆì‹œ: const User = z.object( { username: z.string() } );

[.parse]

dataì˜ íƒ€ì…ì´ ìœ íš¨í•œì§€ ê²€ì‚¬í•˜ê¸° ìœ„í•´ .parse ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìœ íš¨í•œ ê²½ìš° ë°ì´í„° ì „ì²´ ì •ë³´ê°€ í¬í•¨ëœ ê°’ì´ ë°˜í™˜ë©ë‹ˆë‹¤. ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°, ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤. ë³´í†µ try-catch ë¬¸ìœ¼ë¡œ ê°ì‹¸ì„œ ì‚¬ìš©í•œë‹¤ê³  í•©ë‹ˆë‹¤.

[.safeParse]

.parseë¥¼ ì‚¬ìš©í•  ë•Œ íƒ€ì…ì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° Zodê°€ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ëŠ” ê²ƒì„ ì›í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´, .safeParseë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

ë°ì´í„°ê°€ ìœ íš¨í•œ ê²½ìš° trueê°’ì˜ successì™€ ë°ì´í„° ì •ë³´ê°€ ë‹´ê¸´ dataë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” falseê°’ì˜ successì™€ ì—ëŸ¬ ì •ë³´ê°€ ë‹´ê¸´ errorë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ì˜ˆì‹œ : stringSchema.safeParse(12); // => { success: false; error: ZodError }

```tsx
"use server";
import { z } from "zod";

const formSchema = z.object({
  username: z.string().min(3).max(10),
  email: z.string().email(),
  password: z.string().min(10),
  confirm_password: z.string().min(10),
});

export async function createAccount(prevState: any, formData: FormData) {
  const data = {
    username: formData.get("username"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirm_password: formData.get("confirm_password"),
  };
  const result = formSchema.safeParse(data);
  if (!result.success) {
    return result.error.flatten();
  }
}
```

```tsx
"use client";

import FormButton from "@/components/form-btn";
import FormInput from "@/components/form-input";
import SocialLogin from "@/components/social-login";
import { useFormState } from "react-dom";
import { createAccount } from "./actions";

export default function CreateAccount() {
  const [state, dispatch] = useFormState(createAccount, null);
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Fill in the form below to join!</h2>
      </div>
      <form action={dispatch} className="flex flex-col gap-3">
        <FormInput
          name="username"
          type="text"
          placeholder="Username"
          required
          errors={state?.fieldErrors.username}
        />
        <FormInput
          name="email"
          type="email"
          placeholder="Email"
          required
          errors={state?.fieldErrors.email}
        />
        <FormInput
          name="password"
          type="password"
          placeholder="Password"
          required
          errors={state?.fieldErrors.password}
        />
        <FormInput
          name="confirm_password"
          type="password"
          placeholder="Confirm Password"
          required
          errors={state?.fieldErrors.confirm_password}
        />
        <FormButton text="Create account" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

## 6.2 Refinement

Zodì—ëŠ” ëª‡ ê°€ì§€ ë¬¸ìì—´ ê´€ë ¨ ìœ íš¨ì„± ê²€ì‚¬ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. https://zod.dev/?id=strings

ë¬¸ìì—´ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ ë•Œ ëª‡ ê°€ì§€ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
const name = z.string({
  required_error: "Nameì€ í•„ìˆ˜ì…ë‹ˆë‹¤.",
  invalid_type_error: "Nameì€ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.",
});
```

ìœ íš¨ì„± ê²€ì‚¬ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ë•Œ ì¶”ê°€ ì¸ìˆ˜ë¥¼ ì „ë‹¬í•˜ì—¬ ì‚¬ìš©ì ì§€ì • ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`z.string().min(5, { message: "5ê¸€ì ì´ìƒ ë˜ì–´ì•¼í•©ë‹ˆë‹¤." });`

.refine ë©”ì„œë“œë¥¼ í†µí•´ ì‚¬ìš©ì ì§€ì • ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. https://zod.dev/?id=refine

`z.string().refine((val) â‡’ val.length â‰¤ 255, {message: â€œ255ì´í•˜ì˜ ë¬¸ìì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤.â€});`

.refine ì€ 2ê°œì˜ ì¸ìˆ˜ë¥¼ ë°›ìŠµë‹ˆë‹¤.

1. ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜

2. ëª‡ê°€ì§€ ì˜µì…˜

ì œê³µë˜ëŠ” ì˜µì…˜ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- message: ì—ëŸ¬ ë©”ì„¸ì§€ ì§€ì •
- path: ì—ëŸ¬ ê²½ë¡œ ì§€ì •
- params: ì—ëŸ¬ì‹œ ë©”ì„¸ì§€ë¥¼ ì»¤ìŠ¤í…€í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ê°ì²´

```tsx
"use server";
import { z } from "zod";

const formSchema = z
  .object({
    username: z
      .string({
        invalid_type_error: "Username must be a string!",
        required_error: "Where is my username???",
      })
      .min(3, "Way too short!!!")
      .max(10, "That is too looooong!")
      .refine(
        (username) => !username.includes("potato"),
        "No potatoes allowed!"
      ),
    email: z.string().email(),
    password: z.string().min(10),
    confirm_password: z.string().min(10),
  })
  .superRefine(({ password, confirm_password }, ctx) => {
    if (password !== confirm_password) {
      ctx.addIssue({
        code: "custom",
        message: "Two passwords should be equal",
        path: ["confirm_password"],
      });
    }
  });
```

## 6.3 Transformation

// At least one uppercase letter, one lowercase letter, one number and one special character

```tsx
const passwordRegex = new RegExp(
  /^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).+$/
);
```

[.regax]

ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ë°ì´í„° ê²€ì¦ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[.toLowerCase]

String íƒ€ì…ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì†Œë¬¸ìë¡œ ë³€í™˜í•´ì¤ë‹ˆë‹¤.

[.trim]

String íƒ€ì…ì˜ ë°ì´í„°ì—ì„œ ë§¨ì•ê³¼ ë’¤ì— ë¶™ì€ ê³µë°±ì„ ì œê±°í•´ì¤ë‹ˆë‹¤.

[.transform]

ì´ ë©”ì„œë“œë¥¼ ì´ìš©í•˜ë©´ í•´ë‹¹ ë°ì´í„°ë¥¼ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆì‹œ: `.transform((username) => `ğŸ”¥ ${username} ğŸ”¥`)`

```tsx
"use server";
import { z } from "zod";

const passwordRegex = new RegExp(
  /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*?[#?!@$%^&*-]).+$/
);

const formSchema = z
  .object({
    username: z
      .string({
        invalid_type_error: "Username must be a string!",
        required_error: "Where is my username???",
      })
      .min(3, "Way too short!!!")
      //.max(10, "That is too looooong!")
      .trim()
      .toLowerCase()
      .transform((username) => `ğŸ”¥ ${username}`)
      .refine(
        (username) => !username.includes("potato"),
        "No potatoes allowed!"
      ),
    email: z.string().email().toLowerCase(),
    password: z
      .string()
      .min(4)
      .regex(
        passwordRegex,
        "Passwords must contain at least one UPPERCASE, lowercase, number and special characters #?!@$%^&*-"
      ),
    confirm_password: z.string().min(4),
  })
  .superRefine(({ password, confirm_password }, ctx) => {
    if (password !== confirm_password) {
      ctx.addIssue({
        code: "custom",
        message: "Two passwords should be equal",
        path: ["confirm_password"],
      });
    }
  });
export async function createAccount(prevState: any, formData: FormData) {
  const data = {
    username: formData.get("username"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirm_password: formData.get("confirm_password"),
  };
  const result = formSchema.safeParse(data);
  if (!result.success) {
    return result.error.flatten();
  } else {
    console.log(result.data);
  }
}
```

## 6.4 Refactor

1. ì¸í„°ì„¹ì…˜ íƒ€ì…ì„ ì´ìš©í•˜ì—¬ input íƒœê·¸ì— ìˆëŠ” ê¸°ë³¸ ì†ì„±ë“¤ì„ propsë¡œ ë°›ì„ ìˆ˜ ìˆê²Œ í•˜ì˜€ìŠµë‹ˆë‹¤.

2. ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ êµ¬ì¡° ë¶„í•´ í• ë‹¹ê³¼ Spread ì—°ì‚°ìë¥¼ ì´ìš©í•˜ì—¬ ë¦¬íŒ©í† ë§ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

=> ì´ì œ ì»¤ìŠ¤í…€ Input ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•  ë•Œ ì›ë˜ input íƒœê·¸ì— ìˆë˜ ê¸°ë³¸ ì†ì„±ì„ ììœ ë¡­ê²Œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
import { InputHTMLAttributes } from "react";

interface InputProps {
  name: string;
  errors?: string[];
}

export default function Input({
  name,
  errors = [],
  ...rest
}: InputProps & InputHTMLAttributes<HTMLInputElement>) {
  console.log(rest);
  return (
    <div className="flex flex-col gap-2">
      <input
        name={name}
        className="bg-transparent rounded-md w-full h-10 focus:outline-none ring-2 focus:ring-4 transition ring-neutral-200 focus:ring-orange-500 border-none placeholder:text-neutral-400"
        {...rest}
      />
      {errors.map((error, index) => (
        <span key={index} className="text-red-500 font-medium">
          {error}
        </span>
      ))}
    </div>
  );
}
```

## 6.5 Recap

[ğŸ”¥ Super Recap ğŸ”¥]

1. inputì— nameì„ ë„£ì–´ì£¼ì–´ì•¼ formDataì—ì„œ getìœ¼ë¡œ í•´ë‹¹ ë°ì´í„° ê°’ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2. safeParseëŠ” ìŠ¤í‚¤ë§ˆì— ë”°ë¼ ë°ì´í„°ë¥¼ ê²€ì‚¬í•˜ê³  ë³€í˜•ì‹œì¼œì¤ë‹ˆë‹¤.

3. .refineìœ¼ë¡œ ì»¤ìŠ¤í…€ validationì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

objectìì²´ì— refineì„ í•´ì£¼ë©´ ê°ì²´ ì•ˆì— ìˆëŠ” ì „ì²´ ë°ì´í„°ë“¤ì„ ëŒ€ìƒìœ¼ë¡œ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

4. .transformìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³€í˜•ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

5. safeParseëŠ” parseì™€ ë‹¤ë¥´ê²Œ ê²€ì¦ì— ì‹¤íŒ¨í•´ë„ ì—ëŸ¬ë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.

6. ì—ëŸ¬ ê°ì²´ì— flatten ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ì‚¬ìš©í•˜ê¸° ì‰½ê²Œ í¬ë§·íŒ…ë©ë‹ˆë‹¤.

7. ê²€ì¦ ì„±ê³µì‹œ ì›ë³¸ dataë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  result.dataë¥¼ ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.

## 6.6 Log In Validation

1. ìƒìˆ˜ ë¶„ë¦¬
2. Login validation

```tsx
"use server";

import {
  PASSWORD_MIN_LENGTH,
  PASSWORD_REGEX,
  PASSWORD_REGEX_ERROR,
} from "@/lib/constants";
import { z } from "zod";

const formSchema = z.object({
  email: z.string().email().toLowerCase(),
  password: z
    .string({
      required_error: "Password is required",
    })
    .min(PASSWORD_MIN_LENGTH)
    .regex(PASSWORD_REGEX, PASSWORD_REGEX_ERROR),
});

export async function logIn(prevState: any, formData: FormData) {
  const data = {
    email: formData.get("email"),
    password: formData.get("password"),
  };
  const result = formSchema.safeParse(data);
  if (!result.success) {
    console.log(result.error.flatten());
    return result.error.flatten();
  } else {
    console.log(result.data);
  }
}
```

```tsx
"use client";

import FormButton from "@/components/button";
import FormInput from "@/components/input";
import SocialLogin from "@/components/social-login";
import { useFormState } from "react-dom";
import { logIn } from "./actions";
import { PASSWORD_MIN_LENGTH } from "@/lib/constants";

export default function LogIn() {
  const [state, dispatch] = useFormState(logIn, null);
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">ì•ˆë…•í•˜ì„¸ìš”!</h1>
        <h2 className="text-xl">Log in with email and password.</h2>
      </div>
      <form action={dispatch} className="flex flex-col gap-3">
        <FormInput
          name="email"
          type="email"
          placeholder="Email"
          required
          errors={state?.fieldErrors.email}
        />
        <FormInput
          name="password"
          type="password"
          placeholder="Password"
          required
          minLength={PASSWORD_MIN_LENGTH}
          errors={state?.fieldErrors.password}
        />
        <FormButton text="Log in" />
      </form>
      <SocialLogin />
    </div>
  );
}
```

## 6.7 Coerce

- ê°’ ë³€í™˜: transform()
- íƒ€ì… ê°•ì œ ë³€í™˜: coerce()

[Coerce]

ZodëŠ” coerceë¥¼ ì´ìš©í•˜ì—¬ ê°’ì˜ íƒ€ì…ì„ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ëª¨ë“  ì›ì‹œ íƒ€ì…ì´ ì§€ì›ë˜ë©°, ì•„ë˜ì™€ ê°™ì´ ì‘ë™ë©ë‹ˆë‹¤.

z.coerce.string(); // String(input)

z.coerce.number(); // Number(input)

z.coerce.boolean(); // Boolean(input)

z.coerce.bigint(); // BigInt(input)

z.coerce.date(); // new Date(input)

[Validator]

JavaScriptì˜ validator ëª¨ë“ˆì€ ë¬¸ìì—´ ê²€ì¦ ë° ì‚´ê· (sanitization)ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë¬¸ìì—´ ì…ë ¥ì„ ê²€ì¦í•˜ê±°ë‚˜ ì‚´ê· í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì—¬ëŸ¬ í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì´ë©”ì¼ ì£¼ì†Œê°€ ìœ íš¨í•œ í˜•ì‹ì¸ì§€, ë¬¸ìì—´ì´ íŠ¹ì • í˜•ì‹(ì˜ˆ: URL, ë‚ ì§œ)ì— ë§ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ì…ë ¥ìœ¼ë¡œë¶€í„° HTML íƒœê·¸ë¥¼ ì œê±°í•˜ëŠ” ë“±ì˜ ì‚´ê·  ì‘ì—…ë„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
npm i validator
npm i @types/validator
```

validatorë¬¸ìì—´ ìœ íš¨ì„± ê²€ì‚¬ ë¼ì´ë¸ŒëŸ¬ë¦¬

npm i validator

https://www.npmjs.com/package/validator

```tsx
"use server";

import { z } from "zod";
import validator from "validator";

const phoneSchema = z.string().trim().refine(validator.isMobilePhone);

const tokenSchema = z.coerce.number().min(100000).max(999999);

export async function smsLogIn(prevState: any, formData: FormData) {
  console.log(formData.get("token"));
  console.log(tokenSchema.parse(formData.get("token")));
}
```

```tsx
"use client";

import Button from "@/components/button";
import Input from "@/components/input";
import { useFormState } from "react-dom";
import { smsLogIn } from "./actions";

export default function SMSLogin() {
  const [state, dispatch] = useFormState(smsLogIn, null);
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">SMS Log in</h1>
        <h2 className="text-xl">Verify your phone number.</h2>
      </div>
      <form action={dispatch} className="flex flex-col gap-3">
        <Input name="phone" type="number" placeholder="Phone number" required />
        <Input
          name="token"
          type="number"
          placeholder="Verification code"
          required
          min={100000}
          max={999999}
        />
        <Button text="Verify" />
      </form>
    </div>
  );
}
```

## 6.8 SMS Validation

Inputì— keyê°€ ì¤‘ìš”í•œ ì—­í• ì„ í•˜ë‚˜ë³´ë‹¤.

https://react.dev/learn/rendering-lists

```tsx
import { z } from "zod";
import validator from "validator";
import { redirect } from "next/navigation";

const phoneSchema = z
  .string()
  .trim()
  .refine(
    (phone) => validator.isMobilePhone(phone, "ko-KR"),
    "Wrong phone format"
  );

const tokenSchema = z.coerce.number().min(100000).max(999999);

interface ActionState {
  token: boolean;
}

export async function smsLogIn(prevState: ActionState, formData: FormData) {
  const phone = formData.get("phone");
  const token = formData.get("token");
  if (!prevState.token) {
    const result = phoneSchema.safeParse(phone);
    if (!result.success) {
      return {
        token: false,
        error: result.error.flatten(),
      };
    } else {
      return {
        token: true,
      };
    }
  } else {
    const result = tokenSchema.safeParse(token);
    if (!result.success) {
      return {
        token: true,
        error: result.error.flatten(),
      };
    } else {
      redirect("/");
    }
  }
}
```

```tsx
"use client";

import Button from "@/components/button";
import Input from "@/components/input";
import { useFormState } from "react-dom";
import { smsLogIn } from "./actions";

const initialState = {
  token: false,
  error: undefined,
};

export default function SMSLogin() {
  const [state, dispatch] = useFormState(smsLogIn, initialState);
  return (
    <div className="flex flex-col gap-10 py-8 px-6">
      <div className="flex flex-col gap-2 *:font-medium">
        <h1 className="text-2xl">SMS Log in</h1>
        <h2 className="text-xl">Verify your phone number.</h2>
      </div>
      <form action={dispatch} className="flex flex-col gap-3">
        {state.token ? (
          <Input
            key="token"
            name="token"
            type="number"
            placeholder="Verification code"
            required
            min={100000}
            max={999999}
          />
        ) : (
          <Input
            key="phone"
            name="phone"
            type="text"
            placeholder="Phone number"
            required
            errors={state.error?.formErrors}
          />
        )}
        <Button text={state.token ? "Verify Token" : "Send Verification SMS"} />
      </form>
    </div>
  );
}
```

# 7 PRISMA

## 7.0 Setup

PrismsëŠ” DB

Prismaì—ê²Œ Prisma Scheme Languageë¡œ ë‚´ ë°ì´í„° êµ¬ì¡°ë¥¼ ì„¤ëª…í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë©´ PrismaëŠ” SQLì„ ìƒì„±í•©ë‹ˆë‹¤.

Prisma Client, TypeScript, ORM

ë§ˆì´ê·¸ë ˆì´ì…˜ë„ ëŒ

Database Browserë„ ë¨

PrismaëŠ” í†µì—­ì‚¬

ì°¨ì„¸ëŒ€ Node.js ë° TypeScript ORM

https://www.prisma.io/orm

prisma ì´ˆê¸°í™”

```bash
npx prisma init
```

## 7.1 Schemas

ì´ˆê¸°í™” í•˜ë©´ ì•„ë˜ íŒŒì¼ì´ ìƒì„±ë˜ëŠ”ë° ORMì„ ì¶”ê°€í•´ì¤ì‹œë‹¤.

- prisma/schema.prisma

```
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id Int @id @default(autoincrement())
  username String @unique
  email String? @unique
  password String?
  phone String? @unique
  github_id String? @unique
  avatar String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}
```

ê·¸ë¦¬ê³  ì•„ë˜ ëª…ë ¹ì„ ì…ë ¥í•˜ë©´ DBê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

```bash
npx prisma migrate dev
add_user
```

## 7.2 Prisma Client

Prisma ClientëŠ” ë°ì´í„°ì— ë§ì¶° ìë™ ìƒì„±ë˜ëŠ” type-safe ì¿¼ë¦¬ ë¹Œë”ì…ë‹ˆë‹¤.

```bash
// Installation
npm install @prisma/client
```

PrismaëŠ” schema.prismaë¥¼ ë³´ê³  d.tsíŒŒì¼ì„ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.

- lib/db.ts

```tsx
import { PrismaClient } from "@prisma/client";

const db = new PrismaClient();

export async function test() {
  const users = await db.user.findMany({
    where: {
      username: {
        contains: "est",
      },
    },
  });
  console.log(users);
  //   const user = await db.user.create({
  //     data: {
  //       username: "test",
  //     },
  //   });
  //   console.log(user);
}

export default db;
```

// Importing Prisma Client

`import { PrismaClient } from '@prisma/client'`

`const prisma = new PrismaClient()`

https://www.prisma.io/docs/orm/prisma-client/setup-and-configuration/introduction

npx prisma migrate dev ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì˜ ê³¼ì •ì´ í•œë²ˆì— ìˆ˜í–‰ë©ë‹ˆë‹¤.

1. ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ê³ , ìˆ˜ì •ë˜ì—ˆê±°ë‚˜ ì‚­ì œëœ ë¶€ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤.

2. ìƒˆë¡œìš´ ë³€ê²½ ì‚¬í•­ì´ ìˆë‹¤ë©´, ê·¸ê²ƒì„ ì‹œí—˜í•´ ë³¼ ìˆ˜ ìˆëŠ” ë³„ë„ì˜ ë°ì´í„°ë² ì´ìŠ¤ì— ë¨¼ì € ì ìš©í•©ë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸ ëª©ì )

3. ë°ì´í„° ëª¨ë¸ì— ë³€í™”ê°€ ìˆìœ¼ë©´, ê·¸ì— ë§ëŠ” ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë§Œë“­ë‹ˆë‹¤.

4. ëª¨ë“  ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì ìš©í•˜ê³ , ì´ë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.

5. í•„ìš”í•œ ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤. (Prisma Client ë“±..)

ë” ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ ë§í¬ë¥¼ í†µí•´ ê³µë¶€í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[migrate workflows ê³µì‹ ë¬¸ì„œ]

https://www.prisma.io/docs/orm/prisma-migrate/workflows/development-and-production

[migrate workflowsì— ëŒ€í•´ í•œê¸€ë¡œ ì •ë¦¬ëœ ë¸”ë¡œê·¸]

https://pyh.netlify.app/prisma/prisma_migrate/

## 7.3 Prisma Studio

Django adminê°™ì€ ê²ƒ

Prisma Studio

Prisma í”„ë¡œì íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ íƒìƒ‰í•˜ê³  ì¡°ì‘í•˜ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•ì…ë‹ˆë‹¤.

```bash
npx prisma studio
```

https://www.prisma.io/studio

Schemaë³€ê²½ì‹œ â†’ prisma studio ì¢…ë£Œ â†’ migrate â†’ ë‹¤ì‹œ ì‹¤í–‰

## 7.4 Relationships

Userì™€ SMSTokenì„ ì—°ê²°í•˜ë©´ì„œ Relationì„ ë°°ìš¸ê²ë‹ˆë‹¤.

```
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id         Int        @id @default(autoincrement())
  username   String     @unique
  email      String?    @unique
  password   String?
  phone      String?    @unique
  github_id  String?    @unique
  avatar     String?
  created_at DateTime   @default(now())
  updated_at DateTime   @updatedAt
  SMSToken   SMSToken[]
}

model SMSToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
}

```

```tsx
import { PrismaClient } from "@prisma/client";

const db = new PrismaClient();

export async function test() {
  const token = await db.sMSToken.findUnique({
    where: {
      id: 1,
    },
  });
  console.log(token);
}

export default db;
```

## 7.5 onDelete

Userì™€ tokenì´ ê´€ê³„ë§ºê³  ìˆê¸° ë•Œë¬¸ì— userë¥¼ ì§€ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

```
model SMSToken {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
}
```

onDeleteë¥¼ ì •í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. ì—°ê´€ëœ ê°ì²´ë¥¼ ì§€ìš°ëŠ”ê²Œ ê¼­ í•„ìš”í•œ ì¼ì¸ì§€ë„ ìƒê°í•´ë´ì•¼í•©ë‹ˆë‹¤.

# 8 AUTHENTICATION

## 8.1 Database Validation

z.refine(fn)ì—ì„œ fnì€ booleanì„ reuturní•´ì•¼ í•©ë‹ˆë‹¤.

dbì— usernameê³¼ emailì´ uniqueì¸ì§€ í™•ì¸í•˜ê³  ìˆìœ¼ë©´ ì§„í–‰, ì—†ìœ¼ë©´ ì—ëŸ¬ ë°œìƒ.

í•¨ìˆ˜ë¡œ ë¶„ë¦¬í•˜ê³ , z.refineê³¼ ì¡°í•© ê°€ëŠ¥

`const result = await formSchema.safeParseAsync(data);`

async, awaitì— ìœ ì˜

Booleanì‚¬ìš©

- app/create-account/action.ts

```tsx
"use server";
import {
  PASSWORD_MIN_LENGTH,
  PASSWORD_REGEX,
  PASSWORD_REGEX_ERROR,
} from "@/lib/constants";
import db from "@/lib/db";
import { z } from "zod";

const checkUsername = (username: string) => !username.includes("potato");
const checkPasswords = ({
  password,
  confirm_password,
}: {
  password: string;
  confirm_password: string;
}) => password === confirm_password;

const checkUniqueUsername = async (username: string) => {
  const user = await db.user.findUnique({
    where: {
      username,
    },
    select: {
      id: true,
    },
  });
  // if (user) {
  //   return false;
  // } else {
  //   return true;
  // }
  return !Boolean(user);
};

const checkUniqueEmail = async (email: string) => {
  const user = await db.user.findUnique({
    where: {
      email,
    },
    select: {
      id: true,
    },
  });
  return Boolean(user) === false;
};

const formSchema = z
  .object({
    username: z
      .string({
        invalid_type_error: "Username must be a string!",
        required_error: "Where is my username???",
      })
      .toLowerCase()
      .trim()
      // .transform((username) => `ğŸ”¥ ${username} ğŸ”¥`)
      .refine(checkUsername, "No potatoes allowed!")
      .refine(checkUniqueUsername, "This username is already taken"),
    email: z
      .string()
      .email()
      .toLowerCase()
      .refine(
        checkUniqueEmail,
        "There is an account already registered with that email."
      ),
    password: z.string().min(PASSWORD_MIN_LENGTH),
    //.regex(PASSWORD_REGEX, PASSWORD_REGEX_ERROR),
    confirm_password: z.string().min(PASSWORD_MIN_LENGTH),
  })
  .refine(checkPasswords, {
    message: "Both passwords should be the same!",
    path: ["confirm_password"],
  });
export async function createAccount(prevState: any, formData: FormData) {
  const data = {
    username: formData.get("username"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirm_password: formData.get("confirm_password"),
  };
  const result = await formSchema.safeParseAsync(data);
  if (!result.success) {
    return result.error.flatten();
  } else {
    // hash password
    // save the user to db
    // log the user in
    // redirect "/home"
  }
}
```

## 8.2 Password Hashing

bcrypt

```tsx
npm i bcrypt
npm i -D @types/bcrypt
```

How To Safely Store A Password?

https://codahale.com/how-to-safely-store-a-password/

hashing, salting, rainbow

https://youtu.be/67UwxR3ts2E?si=2pqx4IUADxyAzoUj

hash function is one way

how many times do you want to hash? 12 times

```tsx
const hashedPassword = await bcrypt.hash(result.data.password, 12);
```

why do we select only id?

- app/create-account/action.ts

```tsx
export async function createAccount(prevState: any, formData: FormData) {
  const data = {
    username: formData.get("username"),
    email: formData.get("email"),
    password: formData.get("password"),
    confirm_password: formData.get("confirm_password"),
  };
  const result = await formSchema.safeParseAsync(data);
  if (!result.success) {
    return result.error.flatten();
  } else {
    const hashedPassword = await bcrypt.hash(result.data.password, 12);
    const user = await db.user.create({
      data: {
        username: result.data.username,
        email: result.data.email,
        password: hashedPassword,
      },
      select: {
        id: true,
      },
    });
    // log the user in
    // redirect "/home"
  }
}
```

## 8.3 Iron Session

Is user logged in or not?

ì¿ í‚¤ëŠ” ëª¨ë“  ìš”ì²­ì— ë“¤ì–´ê°€ì„œ ëˆ„ê°€ ìš”ì²­í–ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆì–´ìš”

password: process.env.COOKIE_PASSWORD!

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì—ê²Œ ì´ ê°’ì´ ë¬´ì¡°ê±´ ìˆë‹¤ê³  ì•Œë ¤ì¤„ ìˆ˜ ìˆìŒ

### app/create-account/action.ts

```
    const cookie = await getIronSession<typeof user>(cookies(), {
      cookieName: "delicious-karrot",
      password: process.env.COOKIE_PASSWORD!,
    });
    cookie.id = user.id;
    await cookie.save();
    redirect("/profile");
```

### tips

ë¹„ë°€ë²ˆí˜¸ í„¸ë ¸ë‹¤ê³ ? ì•”í˜¸í™”. í•´ì‹œí•¨ìˆ˜. 5ë¶„ ì„¤ëª….

https://www.youtube.com/watch?v=67UwxR3ts2E

ì„¸ì…˜ vs í† í° vs ì¿ í‚¤? ê¸°ì´ˆê°œë… ì¡ì•„ë“œë¦¼. 10ë¶„ ìˆœì‚­!

https://www.youtube.com/watch?v=tosLBcAX1vk

1password password generator

https://1password.com/password-generator/

For generating random 32 character-long password, you may just use terminal command as Next.js documentation introduced:

`openssl rand -base64 32`

https://nextjs.org/docs/app/building-your-application/authentication#1-generating-a-secret-key

### iron-session

```tsx
npm i iron-session
```

## 8.4 Recap

## 8.5 Email Log In

login session êµ¬í˜„

const result = await formSchema.spa(data); â†’ safeParseAsync

zodì™€ bcryptì—ì„œ ë‘ë²ˆ dbì ‘ê·¼

user!.id; â†’ if you know that user exist!!!

- lib/sessions.ts

```tsx
import { getIronSession } from "iron-session";
import { cookies } from "next/headers";

interface SessionContent {
  id?: number;
}

export default function getSession() {
  return getIronSession<SessionContent>(cookies(), {
    cookieName: "delicious-karrot",
    password: process.env.COOKIE_PASSWORD!,
  });
}
```

- app/login/action.ts

```tsx
"use server";

import bcrypt from "bcrypt";
import {
  PASSWORD_MIN_LENGTH,
  PASSWORD_REGEX,
  PASSWORD_REGEX_ERROR,
} from "@/lib/constants";
import db from "@/lib/db";
import { z } from "zod";
import getSession from "@/lib/session";
import { redirect } from "next/navigation";

const checkEmailExists = async (email: string) => {
  const user = await db.user.findUnique({
    where: {
      email,
    },
    select: {
      id: true,
    },
  });
  // if(user){
  //   return true
  // } else {
  //   return false
  // }
  return Boolean(user);
};

const formSchema = z.object({
  email: z
    .string()
    .email()
    .toLowerCase()
    .refine(checkEmailExists, "An account with this email does not exist."),
  password: z.string({
    required_error: "Password is required",
  }),
  // .min(PASSWORD_MIN_LENGTH),
  // .regex(PASSWORD_REGEX, PASSWORD_REGEX_ERROR),
});

export async function logIn(prevState: any, formData: FormData) {
  const data = {
    email: formData.get("email"),
    password: formData.get("password"),
  };
  const result = await formSchema.spa(data);
  if (!result.success) {
    return result.error.flatten();
  } else {
    const user = await db.user.findUnique({
      where: {
        email: result.data.email,
      },
      select: {
        id: true,
        password: true,
      },
    });
    const ok = await bcrypt.compare(
      result.data.password,
      user!.password ?? "xxxx"
    );
    if (ok) {
      const session = await getSession();
      session.id = user!.id;
      redirect("/profile");
    } else {
      return {
        fieldErrors: {
          password: ["Wrong password."],
          email: [],
        },
      };
    }
  }
}
```

## 8.6 superRefine

ì§€ê¸ˆì€ íšŒì›ê°€ì…í•˜ë©´ ëª¨ë“  ê²€ì‚¬ë¥¼ ë‹¤ í•˜ê¸° ë•Œë¬¸ì— DBê°€ ë‘ ë²ˆ í˜¸ì¶œë©ë‹ˆë‹¤. ì´ê±¸ í•´ê²°í•´ë´…ì‹œë‹¤.

ìœ„ì—ì„œ ë§‰íˆë©´ ì•„ë˜ëŠ” ê²€ì‚¬ ì•ˆí•˜ê³  ì¢…ë£Œí•˜ê²Œ ë§Œë“¤ê³  ì‹¶ì–´ìš”

superRefine(callback)ëŠ” refineì˜ ìƒì„¸í•œ ë²„ì „

callback(scheme, refinementCtx)

refinementCtxëŠ” ì—ëŸ¬ ë¬¶ìŒ

https://zod.dev/ERROR_HANDLING?id=zodissue

| field   | type           | details                                                                                         |
| ------- | -------------- | ----------------------------------------------------------------------------------------------- | ------------------------------ |
| code    | z.ZodIssueCode | You can access this enum withÂ z.ZodIssueCode. A full breakdown of the possible values is below. |
| path    | (string        | number)[]                                                                                       | e.g,Â ['addresses', 0, 'line1'] |
| message | string         | e.g.Â Invalid type. Expected string, received number.                                            |

abort early, https://zod.dev/?id=abort-early

```tsx
const formSchema = z
  .object({
    username: z
      .string({
        invalid_type_error: "Username must be a string!",
        required_error: "Where is my username???",
      })
      .toLowerCase()
      .trim()
      // .transform((username) => `ğŸ”¥ ${username} ğŸ”¥`)
      .refine(checkUsername, "No potatoes allowed!"),
    email: z.string().email().toLowerCase(),
    password: z.string().min(PASSWORD_MIN_LENGTH),
    //.regex(PASSWORD_REGEX, PASSWORD_REGEX_ERROR),
    confirm_password: z.string().min(PASSWORD_MIN_LENGTH),
  })
  .superRefine(async ({ username }, ctx) => {
    const user = await db.user.findUnique({
      where: {
        username,
      },
      select: {
        id: true,
      },
    });
    if (user) {
      ctx.addIssue({
        code: "custom",
        message: "This username is already taken",
        path: ["username"],
        fatal: true,
      });
      return z.NEVER;
    }
  })
  .superRefine(async ({ email }, ctx) => {
    const user = await db.user.findUnique({
      where: {
        email,
      },
      select: {
        id: true,
      },
    });
    if (user) {
      ctx.addIssue({
        code: "custom",
        message: "This email is already taken",
        path: ["email"],
        fatal: true,
      });
      return z.NEVER;
    }
  })
  .refine(checkPasswords, {
    message: "Both passwords should be the same!",
    path: ["confirm_password"],
  });
```

## 8.7 Log Out

ë¡œê·¸ì•„ì›ƒì€ ê°„ë‹¨í•©ë‹ˆë‹¤. ì„¸ì…˜ì„ íšë“í•˜ê³ , ì„¸ì…˜ì„ ì—†ì—ë²„ë¦¬ë©´ ë©ë‹ˆë‹¤.

ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë§Œë“¤ ë• form actionì„ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•©ë‹ˆë‹¤

```tsx
<form action={}>
```

https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations#forms

sessionì´ ì—†ëŠ”ë° ë©”ì¸ í˜ì´ì§€ë¡œ ì ‘ì†í•˜ë ¤ê³  í•˜ë©´ notFound()ë¥¼ ì‚¬ìš©í•˜ë©´ ìœ ìš©í•©ë‹ˆë‹¤.

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { notFound, redirect } from "next/navigation";

async function getUser() {
  const session = await getSession();
  if (session.id) {
    const user = await db.user.findUnique({
      where: {
        id: session.id,
      },
    });
    if (user) {
      return user;
    }
  }
  notFound();
}

export default async function Profile() {
  const user = await getUser();
  const logOut = async () => {
    "use server";
    const session = await getSession();
    await session.destroy();
    redirect("/");
  };
  return (
    <div>
      <h1>Welcome! {user?.username}!</h1>
      <form action={logOut}>
        <button>Log out</button>
      </form>
    </div>
  );
}
```

## 8.8 Recap

ì„¸ì…˜ì—ëŠ” ë³´í†µ idë§Œ ë‹´ì§€ë§Œ, ì—­í• ë„ ë‹´ê¸°ë„ í•©ë‹ˆë‹¤.

hashingê³¼ encryptëŠ” ë‹¤ë¦…ë‹ˆë‹¤.

passwordëŠ” hasing, cookieëŠ” encrypt ê·¸ë˜ì•¼ decryptê°€ëŠ¥

formì—ì„œ button, onclickì„ ì‚¬ìš©í•˜ë©´ use clientë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.

use serverì—ì„œ í•˜ê³ ì‹¶ë‹¤ë©´ form actionì„ ì‚¬ìš©í•©ì‹œë‹¤.

## 8.9 Middleware

ë¯¸ë“¤ì›¨ì–´ë€ ì½”ë“œì™€ ì½”ë“œ ì‚¬ì´ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.

/middleware.ts

/app

appê³¼ ê°™ì€ ë ˆë²¨ì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

ë¯¸ë“¤ì›¨ì–´ëŠ” í™ˆí˜ì´ì§€ ê²½ë¡œë¥¼ ìš”ì²­ë§Œ í•´ë„ 7ë²ˆ ì‹¤í–‰ë©ë‹ˆë‹¤. faviconë°›ì„ ë•Œë„ ì‹¤í–‰ë©ë‹ˆë‹¤.

https://nextjs.org/docs/app/api-reference/file-conventions/middleware

- /middleware.ts

```tsx
import { NextRequest, NextResponse } from "next/server";
import getSession from "./lib/session";

export async function middleware(request: NextRequest) {
  const session = await getSession();
  console.log(session);
  if (request.nextUrl.pathname === "/profile") {
    return NextResponse.redirect(new URL("/", request.url));
  }
}
```

## 8.10 Matcher

ì´ì „ì²˜ëŸ¼ requestë¥¼ ì´ìš©í•´ì„œ ë™ì‘ì„ ì²˜ë¦¬í•  ìˆ˜ë„ ìˆì§€ë§Œ, config ë¥¼ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

```tsx
export const config = {
  matcher: ['profile', '/about/:path*', '/dashboard/:path*'],
  matcher: ["/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)"]
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico|logo.svg).*)"],
}
```

```tsx
import { NextRequest } from "next/server";

export async function middleware(request: NextRequest) {
  console.log(request);
}

export const Config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};
```

## 8.12 Authentication Middleware

ë¯¸ë“¤ì›¨ì–´ì—ì„œ ìœ ì €ê°€ URLì„ ì§ì ‘ ì…ë ¥í•  ë•Œ ì–´ë–»ê²Œ ë™ì‘í• ì§€ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
import { NextRequest, NextResponse } from "next/server";
import getSession from "./lib/session";

interface Routes {
  [key: string]: boolean;
}

const publicOnlyUrls: Routes = {
  "/": true,
  "/login": true,
  "/sms": true,
  "/create-account": true,
};

export async function middleware(request: NextRequest) {
  const session = await getSession();
  const exists = publicOnlyUrls[request.nextUrl.pathname];
  if (!session.id) {
    if (!exists) {
      return NextResponse.redirect(new URL("/", request.url));
    }
  } else {
    if (exists) {
      return NextResponse.redirect(new URL("/products", request.url));
    }
  }
}
```

ë¦¬íŒ©í† ë§ ì½”ë“œì…ë‹ˆë‹¤.

```tsx
const publicUrls = new Set(["/", "/login", "/sms", "/create-account"]);

export async function middleware(request: NextRequest) {
  const isPublicPath = publicUrls.has(request.nextUrl.pathname);
  const isLoggedIn = Boolean((await getSession()).id);

  if (!isLoggedIn && !isPublicPath) {
    return NextResponse.redirect(new URL("/", request.url));
  }

  if (isLoggedIn && isPublicPath) {
    return NextResponse.redirect(new URL("/home", request.url));
  }
```

CSSê°€ ì ìš©ë˜ì§€ ì•Šì„ ê²½ìš°, config, Config ì˜¤íƒ€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì•ˆë˜ë©´ ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```tsx
if (request.nextUrl.pathname.startsWith("/_next")) {
  return NextResponse.next();
}
```

https://www.reddit.com/r/nextjs/comments/15gzjwm/nextjs_middleware_redirect_not_serving_css/

## 8.13 Recap

ë¯¸ë“¤ì›¨ì–´ì—ì„œ íŒ¨í‚¤ì§€ëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë„ˆë¬´ ë¬´ê²ê¸° ë•Œë¬¸ì´ì£ !

```tsx
export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
};
```

# 9 SOCIAL AUTHENTICATION

## 9.0 Introduction

ì˜µì…˜ì´ë¼ ë„˜ì–´ê°€ë„ ì¢‹ìŠµë‹ˆë‹¤.

## 9.1 Github Authentication

OAuthíë¦„ ì´í•´!

route.tsëŠ” ìš”ì²­ë§Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

URLSearchParamsëŠ” Node.jsì—ì„œ ì œê³µ

- app/github/start/route.ts

```tsx
export function GET() {
  const baseURL = "https://github.com/login/oauth/authorize";
  const params = {
    client_id: process.env.GITHUB_CLIENT_ID!,
    scope: "read:user,user:email",
    allow_signup: "true",
  };
  const formattedParams = new URLSearchParams(params).toString();
  const finalUrl = `${baseURL}?${formattedParams}`;
  return Response.redirect(finalUrl);
}
```

GitHub Authorizing OAuth apps

ë‹¤ë¥¸ ì‚¬ìš©ìê°€ OAuth appì— ê¶Œí•œì„ ë¶€ì—¬í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

https://docs.github.com/ko/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps

## 9.2 Access Token

Access token íšë“ê³¼ì •

ìœ„ì—ì„œ ë°›ì€ codeë¡œ ë‹¤ì‹œ githubì— ìš”ì²­

ì„±ê³µí•˜ë©´ access tokeníšë“

- app/github/complete/route.ts

```tsx
import { notFound } from "next/navigation";
import { NextRequest } from "next/server";

export async function GET(request: NextRequest) {
  const code = request.nextUrl.searchParams.get("code");
  if (!code) {
    return notFound();
  }
  const accessTokenParams = new URLSearchParams({
    client_id: process.env.GITHUB_CLIENT_ID!,
    client_secret: process.env.GITHUB_CLIENT_SECRET!,
    code,
  }).toString();
  const accessTokenURL = `https://github.com/login/oauth/access_token?${accessTokenParams}`;
  const accessTokenResponse = await fetch(accessTokenURL, {
    method: "POST",
    headers: {
      Accept: "application/json",
    },
  });
  const accessTokenData = await accessTokenResponse.json();
  if ("error" in accessTokenData) {
    return new Response(null, {
      status: 400,
    });
  }
  return Response.json({ accessTokenData });
}
```

## 9.3 Github API

no-cache!!!!!!!!!!!!!!!

usernameì´ ì¤‘ë³µì¼ ê²½ìš° í•´ê²°í•´ì•¼ í•©ë‹ˆë‹¤

ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•˜ì—¬ APIì— ì•¡ì„¸ìŠ¤

ì•¡ì„¸ìŠ¤ í† í°ì„ ì‚¬ìš©í•˜ë©´ ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ APIì— ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- app/github/complete/route.ts

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { notFound, redirect } from "next/navigation";
import { NextRequest } from "next/server";

export async function GET(request: NextRequest) {
  ...
  const userProfileResponse = await fetch("https://api.github.com/user", {
    headers: {
      Authorization: `Bearer ${access_token}`,
    },
    cache: "no-cache",
  });
  const { id, avatar_url, login } = await userProfileResponse.json();
  const user = await db.user.findUnique({
    where: {
      github_id: id + "",
    },
    select: {
      id: true,
    },
  });
  if (user) {
    const session = await getSession();
    session.id = user.id;
    await session.save();
    return redirect("/profile");
  }
  const newUser = await db.user.create({
    data: {
      username: login,
      github_id: id + "",
      avatar: avatar_url,
    },
    select: {
      id: true,
    },
  });
  const session = await getSession();
  session.id = newUser.id;
  await session.save();
  return redirect("/profile");
}

```

```tsx
Authorization: Bearer OAUTH-TOKEN

GET https://api.github.com/user

curl -H "Authorization: Bearer OAUTH-TOKEN" https://api.github.com/user
```

https://docs.github.com/ko/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps#3-use-the-access-token-to-access-the-api

## 9.4 Code Challenge

1. ë¡œê·¸ì¸ ì‹œì¼œì£¼ëŠ” í•¨ìˆ˜ ë§Œë“¤ê³  ì‚¬ìš©í•˜ê¸°

2. Usernameì´ ì¤‘ë³µë˜ëŠ” ê²½ìš° ì—ëŸ¬ í•¸ë“¤ë§í•˜ê¸°

3. Email ì •ë³´ë„ ê³„ì • ìƒì„±ì— í™œìš©í•˜ê¸°

4. Request íŒŒíŠ¸ì™€ Response íŒŒíŠ¸ë¥¼ ë¶„ë¦¬í•˜ê¸°

## 9.5 SMS Token

https://www.twilio.com/en-us

í•¸ë“œí°ìœ¼ë¡œ ë¡œê·¸ì¸ í•  ë•Œ ê°€ì…ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ê°€ì…ì‹œì¼œì£¼ê¸°!

connectOrCreate()

```tsx
"use server";

import crypto from "crypto";
import { z } from "zod";
import validator from "validator";
import { redirect } from "next/navigation";
import db from "@/lib/db";

const phoneSchema = z
  .string()
  .trim()
  .refine(
    (phone) => validator.isMobilePhone(phone, "ko-KR"),
    "Wrong phone format"
  );

const tokenSchema = z.coerce.number().min(100000).max(999999);

interface ActionState {
  token: boolean;
}

async function getToken() {
  const token = crypto.randomInt(100000, 999999).toString();
  const exists = await db.sMSToken.findUnique({
    where: {
      token,
    },
    select: {
      id: true,
    },
  });
  if (exists) {
    return getToken();
  } else {
    return token;
  }
}

export async function smsLogIn(prevState: ActionState, formData: FormData) {
  const phone = formData.get("phone");
  const token = formData.get("token");
  if (!prevState.token) {
    const result = phoneSchema.safeParse(phone);
    if (!result.success) {
      return {
        token: false,
        error: result.error.flatten(),
      };
    } else {
      await db.sMSToken.deleteMany({
        where: {
          user: {
            phone: result.data,
          },
        },
      });
      const token = await getToken();
      await db.sMSToken.create({
        data: {
          token,
          user: {
            connectOrCreate: {
              where: {
                phone: result.data,
              },
              create: {
                username: crypto.randomBytes(10).toString("hex"),
                phone: result.data,
              },
            },
          },
        },
      });
      // send the token using twilio
      return {
        token: true,
      };
    }
  } else {
    const result = tokenSchema.safeParse(token);
    if (!result.success) {
      return {
        token: true,
        error: result.error.flatten(),
      };
    } else {
      redirect("/");
    }
  }
}
```

# 10 PRODUCTS

## 10.0 Introduction

```
model Product {
  id Int @id @default(autoincrement())

  title       String
  price       Float
  photo       String
  description String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
}

```

## 10.1 Tab Bar

Heroicons

https://heroicons.com/

layoutì´ìš©, fixedì´ìš©í•´ì„œ ììœ ìì¬ CSSì‚¬ìš©â€¦

```tsx
"use client";

import {
  HomeIcon as SolidHomeIcon,
  NewspaperIcon as SolidNewspaperIcon,
  ChatBubbleOvalLeftEllipsisIcon as SolidChatIcon,
  VideoCameraIcon as SolidVideoCameraIcon,
  UserIcon as SolidUserIcon,
} from "@heroicons/react/24/solid";
import {
  HomeIcon as OutlineHomeIcon,
  NewspaperIcon as OutlineNewspaperIcon,
  ChatBubbleOvalLeftEllipsisIcon as OutlineChatIcon,
  VideoCameraIcon as OutlineVideoCameraIcon,
  UserIcon as OutlineUserIcon,
} from "@heroicons/react/24/outline";
import Link from "next/link";
import { usePathname } from "next/navigation";

export default function TabBar() {
  const pathname = usePathname();
  return (
    <div className="fixed bottom-0 w-full mx-auto max-w-screen-md grid grid-cols-5 border-neutral-600 border-t px-5 py-3 *:text-white">
      <Link href="/products" className="flex flex-col items-center gap-px">
        {pathname === "/products" ? (
          <SolidHomeIcon className="w-7 h-7" />
        ) : (
          <OutlineHomeIcon className="w-7 h-7" />
        )}
        <span>í™ˆ</span>
      </Link>
      <Link href="/life" className="flex flex-col items-center gap-px">
        {pathname === "/life" ? (
          <SolidNewspaperIcon className="w-7 h-7" />
        ) : (
          <OutlineNewspaperIcon className="w-7 h-7" />
        )}
        <span>ë™ë„¤ìƒí™œ</span>
      </Link>
      <Link href="/chat" className="flex flex-col items-center gap-px">
        {pathname === "/chat" ? (
          <SolidChatIcon className="w-7 h-7" />
        ) : (
          <OutlineChatIcon className="w-7 h-7" />
        )}
        <span>ì±„íŒ…</span>
      </Link>
      <Link href="/live" className="flex flex-col items-center gap-px">
        {pathname === "/live" ? (
          <SolidVideoCameraIcon className="w-7 h-7" />
        ) : (
          <OutlineVideoCameraIcon className="w-7 h-7" />
        )}
        <span>ì‡¼í•‘</span>
      </Link>
      <Link href="/profile" className="flex flex-col items-center gap-px">
        {pathname === "/profile" ? (
          <SolidUserIcon className="w-7 h-7" />
        ) : (
          <OutlineUserIcon className="w-7 h-7" />
        )}
        <span>ë‚˜ì˜ ë‹¹ê·¼</span>
      </Link>
    </div>
  );
}
```

## 10.2 Skeletons

ë¡œë”©ì°½ì„ ë§Œë“¤ì.

pulse ëŒ€ë°•â€¦. CSS ì–´ë µë‹¤.

- app/(tabs)/products/loading.tsx

```tsx
export default function Loading() {
  return (
    <div className="p-5 animate-pulse flex flex-col gap-5">
      {[...Array(10)].map((_, index) => (
        <div key={index} className="*:rounded-md flex gap-5 ">
          <div className="size-28 bg-neutral-700" />
          <div className="flex flex-col gap-2 *:rounded-md">
            <div className="bg-neutral-700 h-5 w-40" />
            <div className="bg-neutral-700 h-5 w-20" />
            <div className="bg-neutral-700 h-5 w-10" />
          </div>
        </div>
      ))}
    </div>
  );
}
```

- app/(tabs)/products/page.tsx

```tsx
async function getProducts() {
  await new Promise((resolve) => setTimeout(resolve, 1000));
}

export default async function Products() {
  const products = await getProducts();
  return (
    <div>
      <h1 className="text-white text-4xl">Products!</h1>
    </div>
  );
}
```

## 10.3 Product Component

/goguma.jpg

<img /> vs <Image />

Layout shift

lazy loading

srcset=â€â€

<Image fill />ì€ absoluteê°€ ëœë‹¤.

<Image quality />

## 10.4 Detail Skeleton

`number.toLocaleString(â€ko-KRâ€);`

Unix epoch

```jsx
const formatter = new Intl.RelativeTimeFormat("ko");

return formatter.format(diff, "days");
```

https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl

Product detail í˜ì´ì§€ì—ì„œëŠ” Tab barê°€ ì—†ëŠ”ê²Œ ë” ë³´ê¸° ì¢‹ì•„ìš”.

- lib/utils.ts

```tsx
export function formatToTimeAgo(date: string): string {
  const dayInMs = 1000 * 60 * 60 * 24;
  const time = new Date(date).getTime();
  const now = new Date().getTime();
  const diff = Math.round((time - now) / dayInMs);

  const formatter = new Intl.RelativeTimeFormat("ko");

  return formatter.format(diff, "days");
}

export function formatToWon(price: number): string {
  return price.toLocaleString("ko-KR");
}
```

next.jsì—ì„œ parameterë¥¼ ì œê³µ

- app/products/[id]/page.tsx

```tsx
async function getProduct() {
  await new Promise((resolve) => setTimeout(resolve, 60000));
}

export default async function ProductDetail({
  params: { id },
}: {
  params: { id: string };
}) {
  const product = await getProduct();
  return <span>Product detail of the product {id}</span>;
}
```

- app/products/[id]/loading.tsx

```tsx
import { PhotoIcon } from "@heroicons/react/24/solid";

export default function Loading() {
  return (
    <div className="animate-pulse p-5 flex flex-col gap-5">
      <div className="aspect-square border-neutral-700 text-neutral-700 border-4 border-dashed rounded-md flex justify-center items-center">
        <PhotoIcon className="h-28" />
      </div>
      <div className="flex gap-2 items-center">
        <div className="size-14 rounded-full bg-neutral-700" />
        <div className="flex flex-col gap-1">
          <div className="h-5 w-40 bg-neutral-700 rounded-md" />
          <div className="h-5 w-20 bg-neutral-700 rounded-md" />
        </div>
      </div>
      <div className="h-10 w-80 bg-neutral-700 rounded-md" />
    </div>
  );
}
```

## 10.5 Product Detail

Code Challenge: Delete product â†’ Products page

CSS ì‘ˆ

- app/products/[id]/page.tsx

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { formatToWon } from "@/lib/utils";
import { UserIcon } from "@heroicons/react/24/solid";
import Image from "next/image";
import Link from "next/link";
import { notFound } from "next/navigation";

async function getIsOwner(userId: number) {
  const session = await getSession();
  if (session.id) {
    return session.id === userId;
  }
  return false;
}

async function getProduct(id: number) {
  const product = await db.product.findUnique({
    where: {
      id,
    },
    include: {
      user: {
        select: {
          username: true,
          avatar: true,
        },
      },
    },
  });
  return product;
}

export default async function ProductDetail({
  params,
}: {
  params: { id: string };
}) {
  const id = Number(params.id);
  if (isNaN(id)) {
    return notFound();
  }
  const product = await getProduct(id);
  if (!product) {
    return notFound();
  }
  const isOwner = await getIsOwner(product.userId);
  return (
    <div>
      <div className="relative aspect-square">
        <Image fill src={product.photo} alt={product.title} />
      </div>
      <div className="p-5 flex items-center gap-3 border-b border-neutral-700">
        <div className="size-10 rounded-full">
          {product.user.avatar !== null ? (
            <Image
              src={product.user.avatar}
              width={40}
              height={40}
              alt={product.user.username}
            />
          ) : (
            <UserIcon />
          )}
        </div>
        <div>
          <h3>{product.user.username}</h3>
        </div>
      </div>
      <div className="p-5">
        <h1 className="text-2xl font-semibold">{product.title}</h1>
        <p>{product.description}</p>
      </div>
      <div className="fixed w-full bottom-0 left-0 p-5 pb-10 bg-neutral-800 flex justify-between items-center">
        <span className="font-semibold text-xl">
          {formatToWon(product.price)}ì›
        </span>
        {isOwner ? (
          <button className="bg-red-500 px-5 py-2.5 rounded-md text-white font-semibold">
            Delete product
          </button>
        ) : null}
        <Link
          className="bg-orange-500 px-5 py-2.5 rounded-md text-white font-semibold"
          href={``}
        >
          ì±„íŒ…í•˜ê¸°
        </Link>
      </div>
    </div>
  );
}
```

## 10.6 Image Hostnames

NextJSì˜ ImageëŠ” ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ ìµœì í™”ë¥¼ í•´ ì£¼ì–´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê³  ë¹ ë¥¸ ë¡œë”©ì´ ë˜ë„ë¡ í•´ ì¤€ë‹¤.

í•˜ì§€ë§Œ ì™¸ë¶€ í˜¸ìŠ¤íŠ¸ì˜ ì´ë¯¸ì§€(ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì˜ ì´ë¯¸ì§€ ë§í¬ ë“±)ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•ŒëŠ” ë³´ì•ˆ ìƒì˜ ì´ìœ ë¡œ ì´ ê¸°ëŠ¥ì´ í—ˆìš©ë˜ì§€ ì•ŠëŠ”ë‹¤.

ë”°ë¼ì„œ next.config.mjsì—ì„œ hostnameë“¤ì„ ë“±ë¡í•´ ì£¼ì–´ì•¼ í•œë‹¤.

(nextConfig > images > remotePatterns > hostname)

Next.jsëŠ” ì™¸ë¶€ ì´ë¯¸ì§€ë¥¼ ìµœì í™”í•˜ëŠ” ê¸°ëŠ¥ì„ ê°–ê³  ìˆëŠ”ë°, ìì›ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë„ë©”ì¸ì„ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.

- next.config.mjs

```tsx
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        hostname: "avatars.githubusercontent.com",
      },
    ],
  },
};

export default nextConfig;
```

## 10.7 Pagination Actions

- className="object-coverâ€
- app/(tabs)/products/actions.ts

```tsx
"use server";

import db from "@/lib/db";

export async function getMoreProducts(page: number) {
  const products = await db.product.findMany({
    select: {
      title: true,
      price: true,
      created_at: true,
      photo: true,
      id: true,
    },
    skip: 1,
    take: 1,
    orderBy: {
      created_at: "desc",
    },
  });
  return products;
}
```

## 10.8 Recap

ì•„ì§ë„ ì´ API ëª¨ë¥´ì…¨ë‹¤ê³ ìš”? ê°œë°œì ì¸ìƒ ê¿€í…œ ì†Œê°œ! JSë¡œ ë¬´í•œ ìŠ¤í¬ë¡¤ êµ¬í˜„í•˜ê¸° (feat: Intersection Observer)

https://www.youtube.com/watch?v=iZhq7I42uaI

- components/product-list.tsx

```tsx
"use client";

import { InitialProducts } from "@/app/(tabs)/products/page";
import ListProduct from "./list-product";
import { useState } from "react";
import { getMoreProducts } from "@/app/(tabs)/products/actions";

interface ProductListProps {
  initialProducts: InitialProducts;
}

export default function ProductList({ initialProducts }: ProductListProps) {
  const [products, setProducts] = useState(initialProducts);
  const [isLoading, setIsLoading] = useState(false);
  const [page, setPage] = useState(0);
  const [isLastPage, setIsLastPage] = useState(false);
  const onLoadMoreClick = async () => {
    setIsLoading(true);
    const newProducts = await getMoreProducts(page + 1);
    if (newProducts.length !== 0) {
      setPage((prev) => prev + 1);
      setProducts((prev) => [...prev, ...newProducts]);
    } else {
      setIsLastPage(true);
    }
    setIsLoading(false);
  };
  return (
    <div className="p-5 flex flex-col gap-5">
      {products.map((product) => (
        <ListProduct key={product.id} {...product} />
      ))}
      {isLastPage ? (
        "No more items"
      ) : (
        <button
          onClick={onLoadMoreClick}
          disabled={isLoading}
          className="text-sm font-semibold bg-orange-500 w-fit mx-auto px-3 py-2 rounded-md hover:opacity-90 active:scale-95"
        >
          {isLoading ? "ë¡œë”© ì¤‘" : "Load more"}
        </button>
      )}
    </div>
  );
}
```

## 10.9 Infinite Scrolling

triggerë¥¼ ë°”ê¿‰ì‹œë‹¤. useRefì‚¬ìš©

const trigger = useRef(1)ëŠ” renderingí•´ë„ ë‚´ë¶€ ê°’ì´ ë°”ë€Œì§€ ì•ŠìŠµë‹ˆë‹¤. triggerì•ˆì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

HTMLSpanElement

IntersectionObserver

# 11 PRODUCT UPLOAD

## 11.0 Introduction

ì•ìœ¼ë¡œ 11, 12, 13ì—ì„œ ë°°ìš¸ ë‚´ìš©

- React Hook Form
- Server Action
- Intercepting Route
- Cache

ì´ë²ˆì— í•  ê²ƒ

- ìƒí’ˆ ì—…ë¡œë“œ ë²„íŠ¼ ë§Œë“¤ê¸°
- ìƒí’ˆ ì—…ë¡œë“œ í˜ì´ì§€ ë§Œë“¤ê¸°

ì¸ìƒì ì¸ ë‚´ìš©

- label htmlForë¥¼ ì´ìš©í•œ ì´ë¯¸ì§€ë¥¼ í´ë¦­ ì‹œ ì—…ë¡œë“œ ê¸°ëŠ¥
- Tailwind CSS, aspect-square
- Tailwind CSS, flex flex-col gap-5
- Tailwind CSS, text-neutral

```tsx
"use client";

import Button from "@/components/button";
import Input from "@/components/input";
import { PhotoIcon } from "@heroicons/react/24/solid";
import { useState } from "react";

export default function AddProduct() {
  const [preview, setPreview] = useState("");
  const onImageChange = () => {};
  return (
    <div>
      <form className="p-5 flex flex-col gap-5">
        <label
          htmlFor="photo"
          className="border-2 aspect-square flex items-center justify-center flex-col text-neutral-300 border-neutral-300 rounded-md border-dashed cursor-pointer"
        >
          <PhotoIcon className="w-20" />
          <div className="text-neutral-400 text-sm">ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>
        </label>
        <input
          onChange={onImageChange}
          type="file"
          id="photo"
          name="photo"
          accept="image/*"
          className="hidden"
        />
        <Input name="title" required placeholder="ì œëª©" type="text" />
        <Input name="price" type="number" required placeholder="ê°€ê²©" />
        <Input
          name="description"
          type="text"
          required
          placeholder="ìì„¸í•œ ì„¤ëª…"
        />
        <Button text="ì‘ì„± ì™„ë£Œ" />
      </form>
    </div>
  );
}
```

## 11.1 Form Action

ì´ë²ˆì— í•  ê²ƒ

- ì—…ë¡œë“œ ë²„íŠ¼ ë™ì‘
- ì‚¬ì§„ ì—…ë¡œë“œ ì‹œ UI ìˆ˜ì •

ì¸ìƒì ì¸ ë‚´ìš©

- @types/react, React.ChangeEvent, HTMLInputElement, FormData
- URL.createObjectURL()
- JavaScriptëŠ” ì ˆëŒ€ ë¡œì»¬ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ìœ ì €ê°€ í—ˆìš©í•´ì•¼ í•©ë‹ˆë‹¤.
- CSS, background-image
- Tailwind CSS, bg-center bg-cover
- HTML, formDataì™€ nameì˜ ê´€ê³„
- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë‘ ë²ˆ ë¹„ìš©ì„ ì‚¬ìš©í•˜ëŠ” ë¬¸ì œ ì¶”í›„ í•´ê²°
- ì´ë¯¸ì§€ ìš©ëŸ‰ ì œí•œ

```json
{
  photo: File {
    size: 17924,
    type: 'image/png',
    name: 'Screenshot 2024-07-15 at 6.43.04Ã¢\x80Â¯PM.png',
    lastModified: 1721036805804
  },
  title: '1',
  price: '1',
  description: '1'
}
```

ì½”ë“œ

- app/products/add/page.tsx

```tsx
"use client";

import Button from "@/components/button";
import Input from "@/components/input";
import { PhotoIcon } from "@heroicons/react/24/solid";
import { useState } from "react";
import { uploadProduct } from "./actions";

export default function AddProduct() {
  const [preview, setPreview] = useState("");
  const onImageChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const {
      target: { files },
    } = event;
    if (!files) {
      return;
    }
    const file = files[0];
    const url = URL.createObjectURL(file);
    setPreview(url);
  };
  return (
    <div>
      <form action={uploadProduct} className="p-5 flex flex-col gap-5">
        <label
          htmlFor="photo"
          className="border-2 aspect-square flex items-center justify-center flex-col text-neutral-300 border-neutral-300 rounded-md border-dashed cursor-pointer bg-center bg-cover"
          style={{
            backgroundImage: `url(${preview})`,
          }}
        >
          {preview === "" ? (
            <>
              <PhotoIcon className="w-20" />
              <div className="text-neutral-400 text-sm">
                ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
              </div>
            </>
          ) : null}
        </label>
        <input
          onChange={onImageChange}
          type="file"
          id="photo"
          name="photo"
          accept="image/*"
          className="hidden"
        />
        <Input name="title" required placeholder="ì œëª©" type="text" />
        <Input name="price" type="number" required placeholder="ê°€ê²©" />
        <Input
          name="description"
          type="text"
          required
          placeholder="ìì„¸í•œ ì„¤ëª…"
        />
        <Button text="ì‘ì„± ì™„ë£Œ" />
      </form>
    </div>
  );
}
```

## 11.2 Product Upload

ì´ë²ˆì— í•  ê²ƒ

- zod Schema ìƒì„± required
- photoê°€ íŒŒì¼ì´ ë§ë‹¤ë©´ ì´ë¯¸ì§€ ì €ì¥
- ì„œë²„ì—ì„œ formDataê²€ì¦
- DBì— file ì €ì¥
- useFormState ì‚¬ìš©

ì¸ìƒì ì¸ ë‚´ìš©

- íŒŒì¼ì„ íŒŒì¼ì‹œìŠ¤í…œì— ì €ì¥í•˜ëŠ” ê²ƒì€ ì¢‹ì€ ë°©ë²•ì´ ì•„ë‹ˆë‹ˆ, ì„ì‹œ ë°©í¸ìœ¼ë¡œ ì‚¬ìš©
- file.arrayBuffer()
- fs.appendFile()
- Buffer.from()
- react-dom, useFormState()

ì½”ë“œ

- app/products/add/action.ts

```tsx
"use server";

import { z } from "zod";
import fs from "fs/promises";
import db from "@/lib/db";
import getSession from "@/lib/session";
import { redirect } from "next/navigation";

const productSchema = z.object({
  photo: z.string({
    required_error: "Photo is required",
  }),
  title: z.string({
    required_error: "Title is required",
  }),
  description: z.string({
    required_error: "Description is required",
  }),
  price: z.coerce.number({
    required_error: "Price is required",
  }),
});

export async function uploadProduct(_: any, formData: FormData) {
  const data = {
    photo: formData.get("photo"),
    title: formData.get("title"),
    price: formData.get("price"),
    description: formData.get("description"),
  };
  if (data.photo instanceof File) {
    const photoData = await data.photo.arrayBuffer();
    await fs.appendFile(`./public/${data.photo.name}`, Buffer.from(photoData));
    data.photo = `/${data.photo.name}`;
  }
  const result = productSchema.safeParse(data);
  if (!result.success) {
    return result.error.flatten();
  } else {
    const session = await getSession();
    if (session.id) {
      const product = await db.product.create({
        data: {
          title: result.data.title,
          description: result.data.description,
          price: result.data.price,
          photo: result.data.photo,
          user: {
            connect: {
              id: session.id,
            },
          },
        },
        select: {
          id: true,
        },
      });
      redirect(`/products/${product.id}`);
      //redirect("/products")
    }
  }
}
```

## 11.3 Images Setup

ì´ë²ˆì— í•  ê²ƒ

- Cloudflare Images

ì¸ìƒì ì¸ ë‚´ìš©

- ì„œë²„ê°€ ì—¬ëŸ¬ê°œê°€ ë˜ë©´ íŒŒì¼ì‹œìŠ¤í…œ ì €ì¥ì€ ì¢‹ì§€ ì•Šë‹¤.
- Vercel, Cloudflare pageê°™ì€ serverlessë¡œ ë°°í¬í•œë‹¤ê³  í•œë‹¤ë©´, ì½”ë“œë¥¼ ë°°í¬í•  ë•Œë§ˆë‹¤ ìƒˆë¡œìš´ ì„œë²„ê°€ ìƒì„±ë˜ê³  ì´ì „ íŒŒì¼ë“¤ì€ ì‚¬ë¼ì§
- ì½”ë“œê°€ í¬í•¨ëœ ì„œë²„ëŠ” í™•ì¥ê³¼ ë³µì œê°€ ê°€ëŠ¥í•´ì•¼ í•˜ë©° ì‹œì‘ê³¼ ì¢…ë£Œë„ ê°€ëŠ¥í•´ì•¼ í•¨.
- Vercelì„ ì‚¬ìš©í•˜ë©´ íŒŒì¼ì´ ì—…ë¡œë“œ ë‹¤ìš´ë¡œë“œ ëª¨ë‘ ë¹„ìš©ì´ ì²­êµ¬ë¨!
- User â†’ Server â†’ CF
- User â†’ Server â†’ CF(Upload URL) â†’ User â†’ CF â†’ Upload URL
- Cloudflare image ì´ë¯¸ì§€ ë³€í˜• ê°€ëŠ¥

íŒ

Cloudflare Image Optimization

https://developers.cloudflare.com/images

## 11.4 Upload URLs

ì´ë²ˆì— í•  ê²ƒ

- ìœ ì €ê°€ ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ Upload URLì„ ë°›ì•„ì˜¤ê¸°

ì¸ìƒì ì¸ ë‚´ìš©

- ìœ ì €ê°€ Form actionì „ì— Inputìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë©´ Upload URLì„ ë°›ì•„ì˜¤ì.

ì½”ë“œ

- app/products/add/actions.ts

```tsx
export async function getUploadUrl() {
  const response = await fetch(
    `https://api.cloudflare.com/client/v4/accounts/${process.env.CLOUDFLARE_ACCOUNT_ID}/images/v2/direct_upload`,
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.CLOUDFLARE_APIKEY}`,
      },
    }
  );
  const data = await response.json();
  console.log(data);
  return data;
}
```

íŒ

https://developers.cloudflare.com/images/upload-images/direct-creator-upload/#request-a-one-time-upload-url

https://api.cloudflare.com/client/v4/accounts/ACCOUNT_ID/images/v2/direct_upload

## 11.5 Image Upload

ì´ë²ˆì— í•  ê²ƒ

- intercept action

ì¸ìƒì ì¸ ë‚´ìš©

- Cloudflare Image ì‚¬ìš©
- malformed URL
- variant

ì½”ë“œ

- app/products/add/page.tsx

```tsx
export default function AddProduct() {
  const [preview, setPreview] = useState("");
  const [uploadUrl, setUploadUrl] = useState("");
  const [photoId, setImageId] = useState("");
  const onImageChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const {
      target: { files },
    } = event;
    if (!files) {
      return;
    }
    const file = files[0];
    const url = URL.createObjectURL(file);
    setPreview(url);
    const { success, result } = await getUploadUrl();
    if (success) {
      const { id, uploadURL } = result;
      setUploadUrl(uploadURL);
      setImageId(id);
    }
  };
  const interceptAction = async (_: any, formData: FormData) => {
    const file = formData.get("photo");
    if (!file) {
      return;
    }
    const cloudflareForm = new FormData();
    cloudflareForm.append("file", file);
    const response = await fetch(uploadUrl, {
      method: "post",
      body: cloudflareForm,
    });
    console.log(await response.text());
    if (response.status !== 200) {
      return;
    }
    const photoUrl = `https://imagedelivery.net/u_qCG_VCNid3SXaUDHw-5Q/${photoId}`;
    formData.set("photo", photoUrl);
    return uploadProduct(_, formData);
  };
  const [state, action] = useFormState(interceptAction, null);
  return (
```

## 11.6 Variants

ì´ë²ˆì— í•  ê²ƒ

- Cloudflare image variant
- Cloudflare image flex varient

ì¸ìƒì ì¸ ë‚´ìš©

ì½”ë“œ

```tsx
src={`${photo}/width=100,height=100`}
```

íŒ

https://developers.cloudflare.com/images/transform-images/transform-via-url/

## 11.8 RHF Refactor

ì´ë²ˆì— í•  ê²ƒ

- React Hook Form
- @hookform/resolvers

ì¸ìƒì ì¸ ë‚´ìš©

- React Hook Formì€ ì´ì œ í•„ìˆ˜ê°€ ì•„ë‹™ë‹ˆë‹¤~ Next.js ìµœì‹ ë²„ì „ì„ ì‚¬ìš©í•˜ë©´ zodë¡œ í•´ê²° ê°€ëŠ¥í•©ë‹ˆë‹¤.
- resolverëŠ” react hook formì´ validationí•  ë•Œ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ê²½ìš° ì—°ê²°í•´ì£¼ëŠ” í”„ë¡œê·¸ë¨
- zodë¥¼ í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ë‘ ê³³ì—ì„œ ë™ì‹œì— ì‚¬ìš©í•˜ê¸°!

ì½”ë“œ

- app/products/add/page.tsx

```tsx
"use client";

import Button from "@/components/button";
import Input from "@/components/input";
import { PhotoIcon } from "@heroicons/react/24/solid";
import { useState } from "react";
import { getUploadUrl, uploadProduct } from "./actions";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { ProductType, productSchema } from "./schema";

export default function AddProduct() {
  const [preview, setPreview] = useState("");
  const [uploadUrl, setUploadUrl] = useState("");
  const [file, setFile] = useState<File | null>(null);
  const {
    register,
    handleSubmit,
    setValue,
    formState: { errors },
  } = useForm<ProductType>({
    resolver: zodResolver(productSchema),
  });
  const onImageChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const {
      target: { files },
    } = event;
    if (!files) {
      return;
    }
    const file = files[0];
    const url = URL.createObjectURL(file);
    setPreview(url);
    setFile(file);
    const { success, result } = await getUploadUrl();
    if (success) {
      const { id, uploadURL } = result;
      setUploadUrl(uploadURL);
      setValue(
        "photo",
        `https://imagedelivery.net/aSbksvJjax-AUC7qVnaC4A/${id}`
      );
    }
  };
  const onSubmit = handleSubmit(async (data: ProductType) => {
    if (!file) {
      return;
    }
    const cloudflareForm = new FormData();
    cloudflareForm.append("file", file);
    const response = await fetch(uploadUrl, {
      method: "post",
      body: cloudflareForm,
    });
    if (response.status !== 200) {
      return;
    }
    const formData = new FormData();
    formData.append("title", data.title);
    formData.append("price", data.price + "");
    formData.append("description", data.description);
    formData.append("photo", data.photo);
    return uploadProduct(formData);
  });
  const onValid = async () => {
    await onSubmit();
  };
  console.log(register("title"));
  return (
    <div>
      <form action={onValid} className="p-5 flex flex-col gap-5">
        <label
          htmlFor="photo"
          className="border-2 aspect-square flex items-center justify-center flex-col text-neutral-300 border-neutral-300 rounded-md border-dashed cursor-pointer bg-center bg-cover"
          style={{
            backgroundImage: `url(${preview})`,
          }}
        >
          {preview === "" ? (
            <>
              <PhotoIcon className="w-20" />
              <div className="text-neutral-400 text-sm">
                ì‚¬ì§„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                {errors.photo?.message}
              </div>
            </>
          ) : null}
        </label>
        <input
          onChange={onImageChange}
          type="file"
          id="photo"
          name="photo"
          accept="image/*"
          className="hidden"
        />
        <Input
          required
          placeholder="ì œëª©"
          type="text"
          {...register("title")}
          errors={[errors.title?.message ?? ""]}
        />
        <Input
          type="number"
          required
          placeholder="ê°€ê²©"
          {...register("price")}
          errors={[errors.price?.message ?? ""]}
        />
        <Input
          type="text"
          required
          placeholder="ìì„¸í•œ ì„¤ëª…"
          {...register("description")}
          errors={[errors.description?.message ?? ""]}
        />
        <Button text="ì‘ì„± ì™„ë£Œ" />
      </form>
    </div>
  );
}
```

íŒ

React Hook Form

https://react-hook-form.com

```tsx
ã„¹npm i react-hook-form @hookform/resolvers
```

https://www.npmjs.com/package/@hookform/resolvers

## 11.9 Recap

ì´ë²ˆì— í•  ê²ƒ

- Input ìˆ˜ì •
  - React, forwardRef
  - React, ForwardedRef
- React Hook Form, setError

ì¸ìƒì ì¸ ë‚´ìš©

```tsx
export type ProductType = z.infer<typeof productSchema>;
```

# 12 MODALS

## 12.0 Introduction

ì´ë²ˆì— í•  ê²ƒ

- ë‘ ê°œì˜ ë©‹ì§„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì„œ NextJSì—ì„œ ëª¨ë‹¬ êµ¬í˜„

ì¸ìƒì ì¸ ë‚´ìš©

- ëª¨ë‹¬ì´ë€ íŒì—…ê³¼ ë¹„ìŠ·í•˜ë‹¤. ê·¸ëŸ°ë° URLì´ ë°”ë€œ!
- ê¸°ëŠ¥ 2ê°œ
  - Parallel Routes
  - Intercepting Routes

## 12.1 Intercepting Routes

ì´ë²ˆì— í•  ê²ƒ

- app/(tabs)/home/(..)products/[id]/page.tsx

ì¸ìƒì ì¸ ë‚´ìš©

Intercepting Routes

- app/(tabs)/home/(..)products/[id]/page.tsx ê°€ app/products/[id]/page.tsxë¥¼ interceptí•˜ì§€ë§Œ, ìƒˆë¡œê³ ì¹¨í•˜ë©´ í›„ìë¡œ ê°

(.) to match segments on the same level

(..) to match segments one level above

(..)(..) to match segments two levels above

(...) to match segments from the root app directory

íŒ

Intercepting Routes

https://nextjs.org/docs/app/building-your-application/routing/intercepting-routes

## 12.2 Intercepting Recap

ì´ë²ˆì— í•  ê²ƒ

- Intercepting Routes test
  - app/(tabs)/home/(.)recent/page.tsx
  - app/(tabs)/home/recent/page.tsx

ì¸ìƒì ì¸ ë‚´ìš©

- íŒŒì¼ ì‹œìŠ¤í…œì´ ì•„ë‹ˆë¼, URL segmentë¡œ ìƒê°í•´ì•¼ í•©ë‹ˆë‹¤.

íŒ

intercept route

https://nextjs.org/docs/app/building-your-application/routing/intercepting-routes

## 12.3 Parallel Routes

ì´ë²ˆì— í•  ê²ƒ

- Parallel Routes

ì¸ìƒì ì¸ ë‚´ìš©

- Parallel RouteëŠ” @ë¡œ ì‹œì‘í•´ì•¼ í•¨
- Layoutì—ì„œ í•¨ê»˜ ë Œë”ë§. ê·¸ëŸ°ë° ì™œ í•„ìš”í•´?
  - ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬í•´ë„ ë˜ì§€ë§Œ, ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ì— ì“°ì´ê¸°ë„í•¨

íŒ

Parallel Routes

https://nextjs.org/docs/app/building-your-application/routing/parallel-routes

## 12.4 Default Routes

ì´ë²ˆì— í•  ê²ƒ

- default.tsx

ì¸ìƒì ì¸ ë‚´ìš©

- app/page.jsëŠ” app/@children/page.jsì™€ ê°™ë‹¤.

íŒ

https://nextjs.org/docs/app/building-your-application/routing/parallel-routes#defaultjs

## 12.5 Modal Route

ì´ë²ˆì— í•  ê²ƒ

- ì‹¤ì œ Modalë§Œë“¤ ì˜ˆì •! CSSëŠ” ë¹¼ê³ 

ì¸ìƒì ì¸ ë‚´ìš©

- ì§„ì§œ ë˜ë„¤????
- ë””ë ‰í† ë¦¬ êµ¬ì¡°ê°€ ì¤‘ìš”!!!

## 12.6 Recap

ì´ë²ˆì— í•  ê²ƒ

ì¸ìƒì ì¸ ë‚´ìš©

- ìƒˆë¡œê³ ì¹¨í•˜ë©´ ëª¨ë‘ ë Œë”ë§í•˜ì§€ë§Œ, <Link>ë¡œ ì´ë™í•˜ë©´ childrenë§Œ ë Œë”ë§ ë¨

```tsx
/home
  -> (..)products/[id]
  -> (..)profile
  -> (.)recent
  /recent
/profile
/products/[id]
```

- slotì´ë€ @ì´ ë¶™ì€ í´ë”ì´ë©° ì´ê²Œ ìˆìœ¼ë©´ Layoutì€ propsë¥¼ ë” ë°›ìŒ.

## 12.7 Modal UI

ì´ë²ˆì— í•  ê²ƒ

- ì½”ë“œì±Œë¦°ì§€
  - loading skeleton
  - ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬
  - ëª¨ë‹¬ì—ì„œ ì‚¬ì§„ ë³´ê¸°

ì¸ìƒì ì¸ ë‚´ìš©

- <button>ì€ use clientë¥¼ ì‚¬ìš©í•´ì•¼í•˜ë‹ˆê¹Œ, ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬!
- useRouter()
- use clientëŠ” async ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

ì½”ë“œ

- app/(tabs)/home/@modal/(...)products/[id]/page.tsx

```tsx
"use client";

import { PhotoIcon, XMarkIcon } from "@heroicons/react/24/solid";
import { useRouter } from "next/navigation";

export default function Modal({ params }: { params: { id: string } }) {
  const router = useRouter();
  const onCloseClick = () => {
    router.back();
  };
  return (
    <div className="absolute w-full h-full z-50 flex items-center justify-center bg-black bg-opacity-60 left-0 top-0">
      <button
        onClick={onCloseClick}
        className="absolute right-5 top-5 text-neutral-200"
      >
        <XMarkIcon className="size-10" />
      </button>
      <div className="max-w-screen-sm h-1/2  flex justify-center w-full">
        <div className="aspect-square  bg-neutral-700 text-neutral-200  rounded-md flex justify-center items-center">
          <PhotoIcon className="h-28" />
        </div>
      </div>
    </div>
  );
}
```

# 13 CACHING

## 13.0 Introduction

ì¸ìƒì ì¸ ë‚´ìš©

- ìºì‹±ì€ ë§¤ìš° ì¤‘ìš”!
- Next.jsì—ì„œ fetchëŠ” cachingë¨.
- ë°ì´í„°ë² ì´ìŠ¤ responseë„ ìºì‹±í•´ë³´ì. ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§¤ë²ˆ ì ‘ê·¼í•˜ë©´ ì•ˆë¨
- generateMetadata
- ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—¬ëŸ¬ êµ°ë°ì—ì„œ ì ‘ê·¼í•  ê²ƒì´ê³  ê°™ì€ ì •ë³´ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¤„ ìƒí™©ì´ ìì£¼ ìƒê¹€

## 13.1 nextCache

ì´ë²ˆì— í•  ê²ƒ

- ìºì‹± ì²˜ìŒ ì‚¬ìš©í•´ë³´ê¸°

ì¸ìƒì ì¸ ë‚´ìš©

```tsx
import { getUser } from './data';
import { unstable_cache } from 'next/cache';

const getCachedUser = unstable_cache(
  async (id) => getUser(id),
  ['my-app-user']
);

export default async function Component({ userID }) {
  const user = await getCachedUser(userID);
  ...
}
```

```tsx
const data = unstable_cache(fetchData, keyParts, options)();
```

```
import { unstable_cache as nextCache } from "next/cache";

const getCachedProducts = nextCache(getInitialProducts, ["home-products"]);
```

- home-productsì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ getInitialProducts ì‹¤í–‰, ìˆìœ¼ë©´ ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ê°’ ì‚¬ìš©
- cachingí• ì§€ ë§ì§€ë„ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- cacheë¥¼ ë§Œë£Œì‹œí‚¤ê±°ë‚˜ ì‹œê°„ ì§€ë‚˜ë©´ ìƒˆë¡œê³ ì¹¨ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

íŒ

unstable_cache

https://nextjs.org/docs/app/api-reference/functions/unstable_cache

ê°œë°œ ëª¨ë“œ && ë¸Œë¼ìš°ì €ì˜ ê°œë°œì ë„êµ¬ë¥¼ opení•œ ìƒíƒœë¼ë©´ unstable_cacheê°€ ìºì‹± ëœ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šê³  dbì— ì ‘ê·¼í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§¤ë²ˆ ì‹¤í–‰í•©ë‹ˆë‹¤!

## 13.2 revalidate

ì´ë²ˆì— í•  ê²ƒ

- revalidate, ê°±ì‹ 

ì¸ìƒì ì¸ ë‚´ìš©

- ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ëŠ” ë¹„ì‹¸ë‹¤
- revalidateë¥¼ ì„¤ì •í–ˆë‹¤ê³  60ì´ˆë§ˆë‹¤ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ”ë‹¤!
- ë§Œë£Œì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ë‚´ìš©

ì½”ë“œ

```tsx
const getCachedProducts = nextCache(getInitialProducts, ["home-products"], {
  revalidate: 60,
});
```

íŒ

- [\*\*Incremental Static Regeneration (ISR)](https://vercel.com/docs/incremental-static-regeneration)ê³¼ ë¹„ìŠ·?\*\*

## 13.3 revalidatePath

ì´ë²ˆì— í•  ê²ƒ

- revalidatePath() ë²„íŠ¼ ë§Œë“¤ê¸°

ì¸ìƒì ì¸ ë‚´ìš©

- /homeê³¼ ì—°ê²°ë˜ì–´ìˆëŠ” ëª¨ë“  ë°ì´í„° ìƒˆë¡œê³ ì¹¨í•´ì¤˜~ ê°€ì¥ ì‰½ë‹¤
- ê·¸ëŸ¬ë‚˜ ëª¨ë“  cacheê°€ ìƒˆë¡œê³ ì¹¨ë˜ê¸° ë•Œë¬¸ì— ì„ íƒí•  ìˆ˜ ì—†ë‹¤.

ì½”ë“œ

- app/(tabs)/home/page.tsx

```tsx
export default async function Products() {
  const initialProducts = await getCachedProducts();
  const revalidate = async () => {
    "use server";
    revalidatePath("/home");
  };
  return (
    <div>
      <ProductList initialProducts={initialProducts} />
      <form action={revalidate}>
        <button>Revalidate</button>
      </form>
      <Link
        href="/products/add"
        className="bg-orange-500 flex items-center justify-center text-white size-16 rounded-full fixed bottom-24 right-8 hover:bg-orange-400 transition-colors"
      >
        <PlusIcon className="size-10" />
      </Link>
    </div>
  );
}
```

íŒ

```tsx
It is not a related to this section, However suddenly I just wondering...!

I can't found any section for SSG and ISR.

And according to my memory past course(NextJS 12 course) has sections for SSG and ISR.

And Im not sure but I think SSR and ISR is so powerful and important feature in NextJS.

So the reason why I can not found any section for SSG and ISR in this course is we can pretend kinda SSR and ISR by "Server Action" with "Unstable Cached" ??

If yes, how can I implement !?
```

```tsx
@jh0152park SSR === Server Side Rendering. To make the page be rendered in the server side you can just add `export const dynamic = "force-dynamic;` to your page. (we learn about this later in this section).

ISR === Incremental Static Regeneration.

For this you can export `export const revalidate = 60` to re validate the page, you can combine that with `generateStaticParams` and `dynamicParams` and you are good to go.

```

## 13.4 revalidateTag

ì´ë²ˆì— í•  ê²ƒ

- revalidateTag()

ì¸ìƒì ì¸ ë‚´ìš©

- ìƒì„¸í˜ì´ì§€ì—ì„œ cachingì„ ë‘ê°œë¥¼ í•˜ëŠ”ë°, í•œê°œë§Œ ëœë‹¤!
- nextCacheëŠ” ì•Œì•„ì„œ paramì„ callbackì— ì „ë‹¬í•©ë‹ˆë‹¤.
- tagsëŠ” ìœ ì¼í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤!

ì½”ë“œ

- app/products/[id]/page.tsx

```tsx
const getCachedProduct = nextCache(getProduct, ["product-detail"], {
  tags: ["product-detail", "xxxx"],
});

async function getProductTitle(id: number) {
  console.log("title");
  const product = await db.product.findUnique({
    where: {
      id,
    },
    select: {
      title: true,
    },
  });
  return product;
}

const getCachedProductTitle = nextCache(getProductTitle, ["product-title"], {
  tags: ["product-title", "xxxx"],
});

export async function generateMetadata({ params }: { params: { id: string } }) {
  const product = await getCachedProductTitle(Number(params.id));
  return {
    title: product?.title,
  };
}

const revalidate = async () => {
  "use server";
  revalidateTag("xxxx");
};
```

## 13.5 fetch Cache

ì´ë²ˆì— í•  ê²ƒ

ì¸ìƒì ì¸ ë‚´ìš©

- Next.jsë¥¼ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  APIì„œë²„ë¥¼ í†µí•´ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤. ì´ë•Œ fetchëŠ” ì¿ í‚¤ë‚˜ í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ cacheë©ë‹ˆë‹¤.
- fetchì— revalidate, tagë¥¼ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
- ëŒ€ë¶€ë¶„ì€ Next.jsë¥¼ ì‚¬ìš©í•  ë•Œ ì™¸ë¶€ APIë¥¼ ì‚¬ìš©í•˜ì§€ ìš°ë¦¬ì²˜ëŸ¼ Prismaë¥¼ ì‚¬ìš©í•´ì„œ dbë¥¼ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤~

ì½”ë“œ

- app/products/[id]/page.tsx

```tsx
async function getProduct(id: number) {
  fetch("https://api.com", {
    next: {
      revalidate: 60,
      tags: ["hello"],
    },
  });
}

const getCachedProduct = nextCache(getProduct, ["product-detail"], {
  revalidate: 60,
  tags: ["product-detail", "hello"],
});
```

## 13.6 Production Cache

ì´ë²ˆì— í•  ê²ƒ

- Next.jsê°€ ì–´ë–»ê²Œ cachingí•˜ëŠ”ì§€ ë°°ìš°ëŠ” ì‹œê°„

ì¸ìƒì ì¸ ë‚´ìš©

- Next.jsëŠ” ì–´ë–»ê²Œ buildí• ê¹Œ?
  - npm run build
  - npm run start vs npm run dev
- staticê³¼ dynamicì˜ ì°¨ì´
  - ì´ í˜ì´ì§€ëŠ” ëˆ„ê°€ ë³´ëŠ”ì§€ì— ë”°ë¼ ë‚´ìš©ì´ ë‹¬ë¼ì§€ë‚˜ìš”? ë„¤â†’ dynamic, ì•„ë‹ˆìš” â†’ static
- /home í˜ì´ì§€ëŠ” DBë¥¼ ì ‘ê·¼í•˜ëŠ”ë°ë„ dynamicì´ ì•„ë‹ˆë¼ staticì´ë„¤ìš”?
  - DBë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ ì¿ í‚¤, í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
  - ë³´ëŠ” ì‚¬ëŒì— ë”°ë¼ ë‚´ìš©ì´ ë°”ë€Œì§€ ì•ŠìŒ
  - ì´ˆê¸° DB, APIì ‘ê·¼ì€ í•œë²ˆë§Œ í•©ë‹ˆë‹¤. ë°”ë€Œë©´ ê·¸ì œì„œì•¼ í•©ë‹ˆë‹¤.
- /profile í˜ì´ì§€ëŠ” dynamicì´ë„¤ìš”?

## 13.7 Route Segment Config

ì´ë²ˆì— í•  ê²ƒ

- customization

ì¸ìƒì ì¸ ë‚´ìš©

- route segment config
  - const dynamic = â€œautoâ€, ìµœëŒ€í•œ ë§ì´ ìºì‹±í•¨
  - const dynamic = â€œforce-dynamicâ€, dynamicë Œë”ë§ì„ ê°•ì œë¡œ ì‹¤í–‰
- ì•„ì£¼ ë©‹ì§„ê¸°ëŠ¥ì¸ revalidate
  - productionì—ì„œ í•´ì•¼í•¨!!!
  - ì•„ì£¼ ë§ì´ ì‚¬ìš©!!!

ì½”ë“œ

- app/(tabs)/home/page.tsx

```tsx
// export const dynamic = "force-dynamic"
export const revalidate = 60;
```

íŒ

ìŒ.. ê·¸ëŸ¬ë©´ dev modeì—ì„œ nextCacheë¡œ ë§Œë“ ê±°ë¥¼ ì‹¤ì œë¡œ productionìœ¼ë¡œ buildí• ë•Œì—ëŠ” cacheë¥¼ ë‹¤ì‹œ ëŒë ¤ë†”ì•¼ í•˜ëŠ”ê±´ê°€ìš”? ì•„ë‹ˆë©´ cacheë¥¼ ì¨ë„ ë˜ê³  ì €ë ‡ê²Œ ì¨ë„ ë˜ê³  ë‘˜ë‹¤ ê°€ëŠ¥í•œ ê±´ê°€ìš”?

ê°œë°œ ëª¨ë“œì—ì„œëŠ” static í˜ì´ì§€ë¥¼ ë§Œë“œëŠ” ì‘ì—…ì´ ì—†ì—ˆê¸° ë•Œë¬¸ì— homeì´ ë‹¤ì´ë‚˜ë¯¹ í˜ì´ì§€ì²˜ëŸ¼ ì‘ë™í•©ë‹ˆë‹¤. ê·¸ë˜ì„œ nextCacheë¥¼ ë„£ì–´ì¤«ë˜ ê²ƒì´ê³ . ë¹Œë“œ í›„ home í˜ì´ì§€ê°€ ë‹¤ì´ë‚˜ë¯¹ìœ¼ë¡œ í• ì§€ staticìœ¼ë¡œ í• ì§€ëŠ” ê°•ì˜ì²˜ëŸ¼ ë³¸ì¸ì´ ì •í•˜ì…”ì„œ ë§Œì•½ ë‹¤ì´ë‚˜ë¯¹ìœ¼ë¡œ í–ˆëŠ”ë° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì‘ì—…ì„ cacheí•˜ê³  ì‹¶ìœ¼ì‹œë‹¤ë©´ ê·¸ë•Œ nextCacheë¥¼ ì ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

Route Segment Config

https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config

## 13.8 Recap part One

ì¸ìƒì ì¸ ë‚´ìš©

- Next.jsì—ì„œë§Œ fetchì˜ ë‘ ë²ˆì§¸ ì¸ìë¡œ nextì˜µì…˜ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- POST, Cookie, DBì ‘ê·¼ì„ í•œë‹¤ë©´ Cacheë¥¼ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
- fetchë¥¼ ì‚¬ìš©í•œ ìë™ cacheì™€ nextCacheì˜ ì°¨ì´ì 

## 13.9 Recap part Two

ì¸ìƒì ì¸ ë‚´ìš©

- ì „ì²´ í”„ë¡œì íŠ¸ ê´€ì ì—ì„œ ìºì‹±
- Server Side Renderingì„ ë¬´ì„œì›Œ í•  í•„ìš”ê°€ ì—†ë‹¤. <Suspense>ë¥¼ ì‚¬ìš©í•˜ë©´ ì¢‹ë‹¤.
- ëª¨ë“  ê²ƒì„ Staticìœ¼ë¡œ ë§Œë“¤ í•„ìš”ê°€ ì—†ë‹¤. <Suspense>ë¥¼ ì‚¬ìš©í•˜ë©´ ë˜ë‹ˆê¹Œ
- ê¸°ë³¸ì€ ìµœëŒ€í•œ ë§ì´ cachingí•˜ëŠ” ê²ƒ

## 13.10 generateStaticParams

ì´ë²ˆì— í•  ê²ƒ

- generateStaticParams

ì¸ìƒì ì¸ ë‚´ìš©

- idê°€ ë­ê°€ ì˜¬ì§€ ì•ˆë‹¤ë©´ ë¯¸ë¦¬ renderingí•´ë‹¬ë¼ê³  í•  ìˆ˜ ìˆë‹¤!
- cookieë¥¼ ì‚¬ìš©í•˜ë©´ prerenderë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- SSG
- ì±…ì„ê° ìˆê²Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. DBì— 10000ê°œ ìˆë‹¤ë©´â€¦?!

ì½”ë“œ

íŒ

generateStaticParams

https://nextjs.org/docs/app/api-reference/functions/generate-static-params

## 13.11 dynamicParams

ì´ë²ˆì— í•  ê²ƒ

- generateStaticParamsìœ¼ë¡œ prerenderingí–ˆëŠ”ë°, ìƒˆë¡œ productë¥¼ ì¶”ê°€í–ˆë‹¤ë©´â€¦.?

ì¸ìƒì ì¸ ë‚´ìš©

- ìƒˆë¡œìš´ ì•„ì´í…œì„ ì¶”ê°€í•˜ë©´ ìë™ìœ¼ë¡œ ì²˜ìŒë§Œ DBì— ì ‘ê·¼í•˜ê³  ì´í›„ì—ëŠ” pre generated htmlì„ ì‘ë‹µí•©ë‹ˆë‹¤.

```tsx
export const dynamicParams = true;
```

- ì•„ë˜ëŠ” ì™œ ì‚¬ìš©í• ê¹Œìš”?

```tsx
export const dynamicParams = false;
```

- ê°€~~~ ë” ì‚¬ìš©í•œë‹¤ê³  í•©ë‹ˆë‹¤.

íŒ

```tsx
InsaneğŸ”¥ğŸ”¥ğŸ”¥
I really really love this section.

Honestly I dont know well about SSG, ISR yet cuz I almost sleeping when I watchced NextJS 12 version course However I fell like can pretend SSG, ISR with Route Segment Configs and generateStaticParams.

I really really love this section!

Thanks a lot and congratulation again to being father!! ğŸ‰
```

## 13.12 Code Challenge

ì´ë²ˆì— í•  ê²ƒ

- /homeê³¼ ì œí’ˆ ì—…ë¡œë“œë¥¼ ì—°ê²° caching
  - í•˜ê³ ì‹¶ì€ caching ì „ëµì„ ì •í•˜ê³  ì œí’ˆ ì—…ë¡œ server actionê³¼ ì—°ê²°í•´ì£¼ì.
  - ì œí’ˆ ë””í…Œì¼ í˜ì´ì§€ì™€ë„ í•´ì£¼ì
- ì œí’ˆ í¸ì§‘ í˜ì´ì§€ ë§Œë“¤ê¸°
  - í¸ì§‘ ì¤‘ ìƒˆë¡œê³ ì¹¨ í–ˆì„ ë•Œ

íŒ

- https://github.com/devgony/carrot-market/commit/05efa740940d8982d3bea88270286bd52b60e3f3
- https://github.com/daehyeong2/carrot-market/commit/ae8755178e270e8c519647a9618ab6314d1e34a4

# 14 OPTIMISTIC UPDATES

## 14.0 Introduction

ì´ë²ˆì— í•  ê²ƒ

- ëª¨ë¸ ìƒì„±

ì¸ìƒì ì¸ ë‚´ìš©

- useOptimistic()
- mutation
- ì‹¤ì œë¡œ ë¹ ë¥´ì§„ ì•Šë”ë¼ë„ ë¹ ë¥´ê²Œ ë³´ì´ëŠ” ë°©ë²•ì„ ë°°ìš¸ ê²ƒì„.
- composite Id
  - likeëŠ” ìœ ì €ê°€ í¬ìŠ¤íŠ¸ì— 1ê°œë§Œ ëˆ„ë¥¼ ìˆ˜ ìˆìŒ
  - @@id(name: "id", [userId, postId])

ì½”ë“œ

- prisma/schema.prisma

```
model Post {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  views       Int       @default(0)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])
  userId      Int
  Comment     Comment[]
  Like        Like[]
}

model Comment {
  id         Int      @id @default(autoincrement())
  payload    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  post       Post     @relation(fields: [postId], references: [id])
  userId     Int
  postId     Int
}

model Like {
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])
  post       Post     @relation(fields: [postId], references: [id])
  userId     Int
  postId     Int

  @@id(name: "id", [userId, postId])
}

```

## 14.1 See Posts

ì´ë²ˆì— í•  ê²ƒ

- ë™ë„¤ìƒí™œ loading.tsx
-

ì¸ìƒì ì¸ ë‚´ìš©

- relation count
  - https://www.prisma.io/docs/orm/prisma-client/queries/aggregation-grouping-summarizing#filter-the-relation-count

ì½”ë“œ

- app/(tabs)/life/page.tsx

```tsx
import db from "@/lib/db";
import { formatToTimeAgo } from "@/lib/utils";
import {
  ChatBubbleBottomCenterIcon,
  HandThumbUpIcon,
} from "@heroicons/react/24/outline";
import Link from "next/link";

async function getPosts() {
  const posts = await db.post.findMany({
    select: {
      id: true,
      title: true,
      description: true,
      views: true,
      created_at: true,
      _count: {
        select: {
          comments: true,
          likes: true,
        },
      },
    },
  });
  return posts;
}

export const metadata = {
  title: "ë™ë„¤ìƒí™œ",
};

export default async function Life() {
  const posts = await getPosts();
  return (
    <div className="p-5 flex flex-col">
      {posts.map((post) => (
        <Link
          key={post.id}
          href={`/posts/${post.id}`}
          className="pb-5 mb-5 border-b border-neutral-500 text-neutral-400 flex  flex-col gap-2 last:pb-0 last:border-b-0"
        >
          <h2 className="text-white text-lg font-semibold">{post.title}</h2>
          <p>{post.description}</p>
          <div className="flex items-center justify-between text-sm">
            <div className="flex gap-4 items-center">
              <span>{formatToTimeAgo(post.created_at.toString())}</span>
              <span>Â·</span>
              <span>ì¡°íšŒ {post.views}</span>
            </div>
            <div className="flex gap-4 items-center *:flex *:gap-1 *:items-center">
              <span>
                <HandThumbUpIcon className="size-4" />
                {post._count.likes}
              </span>
              <span>
                <ChatBubbleBottomCenterIcon className="size-4" />
                {post._count.comments}
              </span>
            </div>
          </div>
        </Link>
      ))}
    </div>
  );
}
```

## 14.2 Likes and Dislikes

ì´ë²ˆì— í•  ê²ƒ

- ì¢‹ì•„ìš”, ì¢‹ì•„ìš” ì·¨ì†Œ
- ê²Œì‹œë¬¼ ìƒì„¸ í˜ì´ì§€

ì¸ìƒì ì¸ ë‚´ìš©

- ì¡°íšŒìˆ˜ ì¦ê°€ë¥¼ ìœ„í•´ findUniqueë¡œ ë°›ì•„ì˜¨ ê²ƒì„ updateí•˜ê±°ë‚˜, updateì‚¬ìš©
- updateëŠ” ì°¾ì§€ ëª»í•˜ë©´ ì—ëŸ¬ ë°œìƒ
- ìƒˆë¡œê³ ì¹¨í•˜ëŠ”ê²Œ ì§œì¦ë‚˜ë‹ˆ ì•„ì£¼ ë‚˜ìœ í•´ê²°ì±…ì¸ revalidatePathë¥¼ ì‚¬ìš©!

ì½”ë“œ

- app/posts/[id]/page.tsx

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { formatToTimeAgo } from "@/lib/utils";
import { EyeIcon, HandThumbUpIcon } from "@heroicons/react/24/solid";
import { revalidatePath } from "next/cache";
import Image from "next/image";
import { notFound } from "next/navigation";

async function getPost(id: number) {
  try {
    const post = await db.post.update({
      where: {
        id,
      },
      data: {
        views: {
          increment: 1,
        },
      },
      include: {
        user: {
          select: {
            username: true,
            avatar: true,
          },
        },
        _count: {
          select: {
            comments: true,
            likes: true,
          },
        },
      },
    });
    return post;
  } catch (e) {
    return null;
  }
}

async function getIsLiked(postId: number) {
  const session = await getSession();
  const like = await db.like.findUnique({
    where: {
      id: {
        postId,
        userId: session.id!,
      },
    },
  });
  return Boolean(like);
}

export default async function PostDetail({
  params,
}: {
  params: { id: string };
}) {
  const id = Number(params.id);
  if (isNaN(id)) {
    return notFound();
  }
  const post = await getPost(id);
  if (!post) {
    return notFound();
  }
  const likePost = async () => {
    "use server";
    const session = await getSession();
    try {
      await db.like.create({
        data: {
          postId: id,
          userId: session.id!,
        },
      });
      revalidatePath(`/post/${id}`);
    } catch (e) {}
  };
  const dislikePost = async () => {
    "use server";
    try {
      const session = await getSession();
      await db.like.delete({
        where: {
          id: {
            postId: id,
            userId: session.id!,
          },
        },
      });
      revalidatePath(`/post/${id}`);
    } catch (e) {}
  };
  const isLiked = await getIsLiked(id);
  return (
    <div className="p-5 text-white">
      <div className="flex items-center gap-2 mb-2">
        <Image
          width={28}
          height={28}
          className="size-7 rounded-full"
          src={post.user.avatar!}
          alt={post.user.username}
        />
        <div>
          <span className="text-sm font-semibold">{post.user.username}</span>
          <div className="text-xs">
            <span>{formatToTimeAgo(post.created_at.toString())}</span>
          </div>
        </div>
      </div>
      <h2 className="text-lg font-semibold">{post.title}</h2>
      <p className="mb-5">{post.description}</p>
      <div className="flex flex-col gap-5 items-start">
        <div className="flex items-center gap-2 text-neutral-400 text-sm">
          <EyeIcon className="size-5" />
          <span>ì¡°íšŒ {post.views}</span>
        </div>
        <form action={isLiked ? dislikePost : likePost}>
          <button
            className={`flex items-center gap-2 text-neutral-400 text-sm border border-neutral-400 rounded-full p-2 hover:bg-neutral-800 transition-colors`}
          >
            <HandThumbUpIcon className="size-5" />
            <span>ê³µê°í•˜ê¸° ({post._count.likes})</span>
          </button>
        </form>
      </div>
    </div>
  );
}
```

## 14.3 Cache Tags

ì´ë²ˆì— í•  ê²ƒ

- ì¢‹ì•„ìš” ê¾¸ë¯¸ê¸°

ì¸ìƒì ì¸ ë‚´ìš©

- customIdë¥¼ tagì— ë„£ëŠ” íŠ¸ë¦­
- unstable_cacheì™€ cookies()ë¥¼ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ë°, ì„œë²„ê°€ ì‘ì—…ì´ ì˜¤ë˜ ê±¸ë ¤ì„œ ì¢‹ì•„ìš” ë°˜ì‘ì´ ì˜¤ë˜ ê±¸ë¦°ë‹¤ë©´??? â†’ useOptimistic()

ì½”ë“œ

- app/posts/[id]/page.tsx

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { formatToTimeAgo } from "@/lib/utils";
import { EyeIcon, HandThumbUpIcon } from "@heroicons/react/24/solid";
import { HandThumbUpIcon as OutlineHandThumbUpIcon } from "@heroicons/react/24/outline";
import { unstable_cache as nextCache, revalidateTag } from "next/cache";
import Image from "next/image";
import { notFound } from "next/navigation";

async function getPost(id: number) {
  try {
    const post = await db.post.update({
      where: {
        id,
      },
      data: {
        views: {
          increment: 1,
        },
      },
      include: {
        user: {
          select: {
            username: true,
            avatar: true,
          },
        },
        _count: {
          select: {
            comments: true,
          },
        },
      },
    });
    return post;
  } catch (e) {
    return null;
  }
}

const getCachedPost = nextCache(getPost, ["post-detail"], {
  tags: ["post-detail"],
  revalidate: 60,
});

async function getLikeStatus(postId: number, userId: number) {
  // const session = await getSession();
  const isLiked = await db.like.findUnique({
    where: {
      id: {
        postId,
        userId: userId,
      },
    },
  });
  const likeCount = await db.like.count({
    where: {
      postId,
    },
  });
  return {
    likeCount,
    isLiked: Boolean(isLiked),
  };
}

async function getCachedLikeStatus(postId: number) {
  const session = await getSession();
  const userId = session.id;
  const cachedOperation = nextCache(getLikeStatus, ["product-like-status"], {
    tags: [`like-status-${postId}`],
  });
  return cachedOperation(postId, userId!);
}

export default async function PostDetail({
  params,
}: {
  params: { id: string };
}) {
  const id = Number(params.id);
  if (isNaN(id)) {
    return notFound();
  }
  const post = await getCachedPost(id);
  if (!post) {
    return notFound();
  }
  const likePost = async () => {
    "use server";
    await new Promise((r) => setTimeout(r, 5000));
    const session = await getSession();
    try {
      await db.like.create({
        data: {
          postId: id,
          userId: session.id!,
        },
      });
      revalidateTag(`like-status-${id}`);
    } catch (e) {}
  };
  const dislikePost = async () => {
    "use server";
    try {
      const session = await getSession();
      await db.like.delete({
        where: {
          id: {
            postId: id,
            userId: session.id!,
          },
        },
      });
      revalidateTag(`like-status-${id}`);
    } catch (e) {}
  };
  const { likeCount, isLiked } = await getCachedLikeStatus(id);
  return (
    <div className="p-5 text-white">
      <div className="flex items-center gap-2 mb-2">
        <Image
          width={28}
          height={28}
          className="size-7 rounded-full"
          src={post.user.avatar!}
          alt={post.user.username}
        />
        <div>
          <span className="text-sm font-semibold">{post.user.username}</span>
          <div className="text-xs">
            <span>{formatToTimeAgo(post.created_at.toString())}</span>
          </div>
        </div>
      </div>
      <h2 className="text-lg font-semibold">{post.title}</h2>
      <p className="mb-5">{post.description}</p>
      <div className="flex flex-col gap-5 items-start">
        <div className="flex items-center gap-2 text-neutral-400 text-sm">
          <EyeIcon className="size-5" />
          <span>ì¡°íšŒ {post.views}</span>
        </div>
        <form action={isLiked ? dislikePost : likePost}>
          <button
            className={`flex items-center gap-2 text-neutral-400 text-sm border border-neutral-400 rounded-full p-2  transition-colors ${
              isLiked
                ? "bg-orange-500 text-white border-orange-500"
                : "hover:bg-neutral-800"
            }`}
          >
            {isLiked ? (
              <HandThumbUpIcon className="size-5" />
            ) : (
              <OutlineHandThumbUpIcon className="size-5" />
            )}
            {isLiked ? (
              <span> {likeCount}</span>
            ) : (
              <span>ê³µê°í•˜ê¸° ({likeCount})</span>
            )}
          </button>
        </form>
      </div>
    </div>
  );
}
```

## 14.4 useOptimistic

### ì´ë²ˆì— í•  ê²ƒ

- React useOptimistic ì‚¬ìš©
- action, button ë¶„ë¦¬

### ì¸ìƒì ì¸ ë‚´ìš©

- ìœ ì €ê°€ ë°ì´í„°ë¥¼ ë³´ë‚´ì£¼ë©´ ê±°ê¸°ì— ë§ê²Œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ mutation
  - ë‘ ê°€ì§€ ì˜µì…˜
    - ë°±ì—”ë“œê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸°
    - like, dislikeëŠ” ì¤‘ìš”í•˜ì§€ ì•Šì•„ì„œ êµ³ì´ ë‹¤ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ì´ optimistic responseë¥¼ ì£¼ì
      - ì„±ê³µí•œ ê²ƒì²˜ëŸ¼ UIë¥¼ ë³€ê²½
        - ì—„ì²­ ë§ì´ ì‚¬ìš©í•¨!!!

```tsx
[optimisticState, addOptimistic] = useOptimistic(state, updateFn);
```

state: ê¸°ì¡´ state

optimisticState: ì„ì‹œë¡œ ë³´ì—¬ì¤„ state

addOptimistic: ì‹œê°„ì´ ì¢€ ê±¸ë¦¬ëŠ” action trigger

updateFn: ???

### ì½”ë“œ

- app/posts/[id]/page.tsx

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { formatToTimeAgo } from "@/lib/utils";
import { EyeIcon, HandThumbUpIcon } from "@heroicons/react/24/solid";
import { HandThumbUpIcon as OutlineHandThumbUpIcon } from "@heroicons/react/24/outline";
import { unstable_cache as nextCache, revalidateTag } from "next/cache";
import Image from "next/image";
import { notFound } from "next/navigation";
import LikeButton from "@/components/like-button";

async function getPost(id: number) {
  try {
    const post = await db.post.update({
      where: {
        id,
      },
      data: {
        views: {
          increment: 1,
        },
      },
      include: {
        user: {
          select: {
            username: true,
            avatar: true,
          },
        },
        _count: {
          select: {
            comments: true,
          },
        },
      },
    });
    return post;
  } catch (e) {
    return null;
  }
}

const getCachedPost = nextCache(getPost, ["post-detail"], {
  tags: ["post-detail"],
  revalidate: 60,
});

async function getLikeStatus(postId: number, userId: number) {
  // const session = await getSession();
  const isLiked = await db.like.findUnique({
    where: {
      id: {
        postId,
        userId: userId,
      },
    },
  });
  const likeCount = await db.like.count({
    where: {
      postId,
    },
  });
  return {
    likeCount,
    isLiked: Boolean(isLiked),
  };
}

async function getCachedLikeStatus(postId: number) {
  const session = await getSession();
  const userId = session.id;
  const cachedOperation = nextCache(getLikeStatus, ["product-like-status"], {
    tags: [`like-status-${postId}`],
  });
  return cachedOperation(postId, userId!);
}

export default async function PostDetail({
  params,
}: {
  params: { id: string };
}) {
  const id = Number(params.id);
  if (isNaN(id)) {
    return notFound();
  }
  const post = await getCachedPost(id);
  if (!post) {
    return notFound();
  }
  const { likeCount, isLiked } = await getCachedLikeStatus(id);
  return (
    <div className="p-5 text-white">
      <div className="flex items-center gap-2 mb-2">
        <Image
          width={28}
          height={28}
          className="size-7 rounded-full"
          src={post.user.avatar!}
          alt={post.user.username}
        />
        <div>
          <span className="text-sm font-semibold">{post.user.username}</span>
          <div className="text-xs">
            <span>{formatToTimeAgo(post.created_at.toString())}</span>
          </div>
        </div>
      </div>
      <h2 className="text-lg font-semibold">{post.title}</h2>
      <p className="mb-5">{post.description}</p>
      <div className="flex flex-col gap-5 items-start">
        <div className="flex items-center gap-2 text-neutral-400 text-sm">
          <EyeIcon className="size-5" />
          <span>ì¡°íšŒ {post.views}</span>
        </div>
        <LikeButton isLiked={isLiked} likeCount={likeCount} postId={id} />
      </div>
    </div>
  );
}
```

- app/posts/[id]/actions.ts

```tsx
"use server";

import db from "@/lib/db";
import getSession from "@/lib/session";
import { revalidateTag } from "next/cache";

export async function likePost(postId: number) {
  await new Promise((r) => setTimeout(r, 10000));
  const session = await getSession();
  try {
    await db.like.create({
      data: {
        postId,
        userId: session.id!,
      },
    });
    revalidateTag(`like-status-${postId}`);
  } catch (e) {}
}

export async function dislikePost(postId: number) {
  await new Promise((r) => setTimeout(r, 10000));
  try {
    const session = await getSession();
    await db.like.delete({
      where: {
        id: {
          postId,
          userId: session.id!,
        },
      },
    });
    revalidateTag(`like-status-${postId}`);
  } catch (e) {}
}
```

- components/like-button.tsx

```tsx
"use client";

import { HandThumbUpIcon } from "@heroicons/react/24/solid";
import { HandThumbUpIcon as OutlineHandThumbUpIcon } from "@heroicons/react/24/outline";
import { useOptimistic } from "react";
import { dislikePost, likePost } from "@/app/posts/[id]/actions";

interface LikeButtonProps {
  isLiked: boolean;
  likeCount: number;
  postId: number;
}

export default function LikeButton({
  isLiked,
  likeCount,
  postId,
}: LikeButtonProps) {
  const [state, reducerFn] = useOptimistic(
    { isLiked, likeCount },
    (previousState, payload) => ({
      isLiked: !previousState.isLiked,
      likeCount: previousState.isLiked
        ? previousState.likeCount - 1
        : previousState.likeCount + 1,
    })
  );
  const onClick = async () => {
    reducerFn(undefined);
    if (isLiked) {
      await dislikePost(postId);
    } else {
      await likePost(postId);
    }
  };
  return (
    <button
      onClick={onClick}
      className={`flex items-center gap-2 text-neutral-400 text-sm border border-neutral-400 rounded-full p-2  transition-colors ${
        state.isLiked
          ? "bg-orange-500 text-white border-orange-500"
          : "hover:bg-neutral-800"
      }`}
    >
      {state.isLiked ? (
        <HandThumbUpIcon className="size-5" />
      ) : (
        <OutlineHandThumbUpIcon className="size-5" />
      )}
      {state.isLiked ? (
        <span> {state.likeCount}</span>
      ) : (
        <span>ê³µê°í•˜ê¸° ({state.likeCount})</span>
      )}
    </button>
  );
}
```

# 15 REALTIME CHAT

## 15.0 Introduction

### ì¸ìƒì ì¸ ë‚´ìš©

- supabaseë³´ë‹¤ cloudflareê°€ ë” ì¢‹ìŒ

## 15.1 Models

### ì´ë²ˆì— í•  ê²ƒ

- chatRoom, message ëª¨ë¸ ë§Œë“¤ê¸°

### ì¸ìƒì ì¸ ë‚´ìš©

- cuid

### ì½”ë“œ

- prisma/schema.prisma

```
model ChatRoom {
  id    String @id @default(cuid())
  users User[]

  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  Message    Message[]
}

model Message {
  id      Int    @id @default(autoincrement())
  payload String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  room       ChatRoom @relation(fields: [chatRoomId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
  chatRoomId String
  userId     Int
}

```

### íŒ

CUID

https://www.prisma.io/docs/orm/reference/prisma-schema-reference#cuid

https://github.com/paralleldrive/cuid

https://github.com/paralleldrive/cuid2

## 15.2 Chat Room

### ì´ë²ˆì— í•  ê²ƒ

- chat í˜ì´ì§€ ë§Œë“¤ê¸°
- chat ë²„íŠ¼ êµ¬í˜„

### ì¸ìƒì ì¸ ë‚´ìš©

- use serverë¥¼ ì‚¬ìš©í•œë‹¤ë©´ íŒŒì¼ë¡œ ë¶„ë¦¬í•˜ì

## 15.3 Messages

### ì´ë²ˆì— í•  ê²ƒ

- ë©”ì‹œì§€ ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°
- ì´ˆê¸° ë©”ì‹œì§€ ì „ë‹¬

### ì¸ìƒì ì¸ ë‚´ìš©

- UI ì‘ì—… ë¯¸ì³¤ë‹¤~

### ì½”ë“œ

- app/chats/[id]/page.tsx

```tsx
import ChatMessagesList from "@/components/chat-messages-list";
import db from "@/lib/db";
import getSession from "@/lib/session";
import { Prisma } from "@prisma/client";
import { notFound } from "next/navigation";

async function getRoom(id: string) {
  const room = await db.chatRoom.findUnique({
    where: {
      id,
    },
    include: {
      users: {
        select: { id: true },
      },
    },
  });
  if (room) {
    const session = await getSession();
    const canSee = Boolean(room.users.find((user) => user.id === session.id!));
    if (!canSee) {
      return null;
    }
  }
  return room;
}

async function getMessages(chatRoomId: string) {
  const messages = await db.message.findMany({
    where: {
      chatRoomId,
    },
    select: {
      id: true,
      payload: true,
      created_at: true,
      userId: true,
      user: {
        select: {
          avatar: true,
          username: true,
        },
      },
    },
  });
  return messages;
}

export type InitialChatMessages = Prisma.PromiseReturnType<typeof getMessages>;

export default async function ChatRoom({ params }: { params: { id: string } }) {
  const room = await getRoom(params.id);
  if (!room) {
    return notFound();
  }
  const initialMessages = await getMessages(params.id);
  const session = await getSession();
  return (
    <ChatMessagesList userId={session.id!} initialMessages={initialMessages} />
  );
}
```

- components/chat-messages-list.tsx

```tsx
"use client";

import { InitialChatMessages } from "@/app/chats/[id]/page";
import { formatToTimeAgo } from "@/lib/utils";
import { ArrowUpCircleIcon } from "@heroicons/react/24/solid";
import Image from "next/image";
import { useRef, useState } from "react";

interface ChatMessageListProps {
  initialMessages: InitialChatMessages;
  userId: number;
}
export default function ChatMessagesList({
  initialMessages,
  userId,
}: ChatMessageListProps) {
  const [messages, setMessages] = useState(initialMessages);
  const [message, setMessage] = useState("");
  const onChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const {
      target: { value },
    } = event;
    setMessage(value);
  };
  const onSubmit = (event: React.FormEvent) => {
    event.preventDefault();
    alert(message);
    setMessage("");
  };
  return (
    <div className="p-5 flex flex-col gap-5 min-h-screen justify-end">
      {messages.map((message) => (
        <div
          key={message.id}
          className={`flex gap-2 items-start ${
            message.userId === userId ? "justify-end" : ""
          }`}
        >
          {message.userId === userId ? null : (
            <Image
              src={message.user.avatar!}
              alt={message.user.username}
              width={50}
              height={50}
              className="size-8 rounded-full"
            />
          )}
          <div
            className={`flex flex-col gap-1 ${
              message.userId === userId ? "items-end" : ""
            }`}
          >
            <span
              className={`${
                message.userId === userId ? "bg-neutral-500" : "bg-orange-500"
              } p-2.5 rounded-md`}
            >
              {message.payload}
            </span>
            <span className="text-xs">
              {formatToTimeAgo(message.created_at.toString())}
            </span>
          </div>
        </div>
      ))}
      <form className="flex relative" onSubmit={onSubmit}>
        <input
          required
          onChange={onChange}
          value={message}
          className="bg-transparent rounded-full w-full h-10 focus:outline-none px-5 ring-2 focus:ring-4 transition ring-neutral-200 focus:ring-neutral-50 border-none placeholder:text-neutral-400"
          type="text"
          name="message"
          placeholder="Write a message..."
        />
        <button className="absolute right-0">
          <ArrowUpCircleIcon className="size-10 text-orange-500 transition-colors hover:text-orange-300" />
        </button>
      </form>
    </div>
  );
}
```

## 15.4 Realtime Channel

### ì´ë²ˆì— í•  ê²ƒ

- ë©”ì‹œì§€ ì…ë ¥ ê¸°ëŠ¥ ì¶”ê°€
- ê°€ì§œ ë©”ì‹œì§€ ì¶œë ¥
- supabase

### ì¸ìƒì ì¸ ë‚´ìš©

- https://supabase.com/docs/guides/realtime/broadcast

### ì½”ë“œ

- components/input.tsx

```tsx
const onSubmit = (event: React.FormEvent) => {
  event.preventDefault();
  setMessages((prevMsgs) => [
    ...prevMsgs,
    {
      id: Date.now(),
      payload: message,
      created_at: new Date(),
      userId,
      user: {
        username: "string",
        avatar: "xxx",
      },
    },
  ]);
  setMessage("");
};
useEffect(() => {
  const client = createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);
  console.log(client);
  const channel = client.channel(`room-${chatRoomId}`);
  channel.on("broadcast", { event: "message" }, (payload) => {
    console.log(payload);
  });
}, [chatRoomId]);
```

### íŒ

ì±„íŒ…ë°© ë§Œë“¤ê³  ì£¼ì†Œ ì €ì¥í•´ ë†”ì•¼ í•©ë‹ˆë‹¤ ~! ë’¤ë¡œ ê°€ê¸° í–ˆë‹¤ê°€ ëˆ„ë¥´ë©´ ì±„íŒ…ë°© ì±„íŒ…ë°© ì¶”ê°€ë¡œ ë§Œë“¤ì–´ ì ¸ì„œ ë©”ì„¸ì§€ ì‚¬ë¼ ì§‘ë‹ˆë‹¤

---

ì €ë„ ë˜‘ê°™ì´ ê·¸ë˜ì„œ chatRoomì— productIdë¥¼ ë„£ì–´ë²„ë ¸ì–´ìš”. ìƒì„±í•˜ê¸° ì „ì— ì´ productì— user id, session id ê°™ì´ ìˆëŠ” chatRoomì´ ìˆìœ¼ë©´ ìƒì„±í•˜ì§€ ì•Šê³  ê±°ê¸°ë¡œ ì´ë™ì‹œí‚¤ëŠ” ë°©ì‹ìœ¼ë¡œ~!

## 15.5 Supabase Broadcast

### ì´ë²ˆì— í•  ê²ƒ

- supabase subscribe

### ì¸ìƒì ì¸ ë‚´ìš©

- useRefëŠ” ì•„ì£¼ ìœ ìš©í•©ë‹ˆë‹¤! ì»´í¬ë„ŒíŠ¸ ë‚´ì—ì„œ ì—¬ëŸ¬ í•¨ìˆ˜ì—ì„œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ useRef
- channel.send
- channel.on
- channel.subscribe

### ì½”ë“œ

```tsx
const channel = useRef<RealtimeChannel>();
```

### íŒ

Multiple GoTrueClient instances detected in the same browser context

- -->

ì¸ìŠ¤í„´ìŠ¤ ì¤‘ë³µì— ì˜í•œ ë¬¸ì œ.

const client = createClient ë¥¼ í•¨ìˆ˜ ë°–ì— ì„ ì–¸ í•˜ë©´ ë©ë‹ˆë‹¤.

## 15.6 Realtime Messages

### ì´ë²ˆì— í•  ê²ƒ

- ë©”ì‹œì§€ì— ìœ ì €ì´ë¦„ê³¼ ì•„ë°”íƒ€ë„ ë³´ë‚´ê¸°
- ì†Œì¼“ìœ¼ë¡œ ë°›ì€ ë©”ì‹œì§€ state ë°˜ì˜

### ì¸ìƒì ì¸ ë‚´ìš©

- ì±Œë¦°ì§€
  - getUserProfile ìºì‹±

### ì½”ë“œ

- app/chats/[id]/page.tsx

```tsx
async function getUserProfile() {
  const session = await getSession();
  const user = await db.user.findUnique({
    where: {
      id: session.id!,
    },
    select: {
      username: true,
      avatar: true,
    },
  });
  return user;
}

export type InitialChatMessages = Prisma.PromiseReturnType<typeof getMessages>;

export default async function ChatRoom({ params }: { params: { id: string } }) {
  const room = await getRoom(params.id);
  if (!room) {
    return notFound();
  }
  const initialMessages = await getMessages(params.id);
  const session = await getSession();
  const user = await getUserProfile();
  if (!user) {
    return notFound();
  }
  return (
    <ChatMessagesList
      chatRoomId={params.id}
      userId={session.id!}
      username={user.username}
      avatar={user.avatar!}
      initialMessages={initialMessages}
    />
  );
}
```

- components/chat-messages-list.tsx

```tsx
const onSubmit = (event: React.FormEvent) => {
  event.preventDefault();
  setMessages((prevMsgs) => [
    ...prevMsgs,
    {
      id: Date.now(),
      payload: message,
      created_at: new Date(),
      userId,
      user: {
        username: "string",
        avatar: "xxx",
      },
    },
  ]);
  channel.current?.send({
    type: "broadcast",
    event: "message",
    payload: {
      id: Date.now(),
      payload: message,
      created_at: new Date(),
      userId,
      user: {
        username,
        avatar,
      },
    },
  });
  setMessage("");
};
useEffect(() => {
  const client = createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);
  channel.current = client.channel(`room-${chatRoomId}`);
  channel.current
    .on("broadcast", { event: "message" }, (payload) => {
      setMessages((prevMsgs) => [...prevMsgs, payload.payload]);
    })
    .subscribe();
  return () => {
    channel.current?.unsubscribe();
  };
}, [chatRoomId]);
```

## 15.7 Code Challenge

### ì´ë²ˆì— í•  ê²ƒ

- ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì‚¬ë¼ëŠ” ê²ƒì„ í•´ê²°
- ì±Œë¦°ì§€
  - ì±„íŒ… íƒ­ êµ¬í˜„
    - ëª¨ë“  ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì£¼ê¸°
    - ë‚´ê°€ ëŒ€í™”í•˜ê³  ìˆëŠ” ì±„íŒ…ë°©ê³¼ ì•„ë°”íƒ€ ê·¸ë¦¬ê³  ìµœì‹  ë©”ì‹œì§€ ë³´ì—¬ì£¼ê¸°
  - ì½ì§€ ì•Šì€ ì±„íŒ…ë°©ì´ ì–´ëŠ ê²ƒì¸ì§€
  - ì½ì€ ì±„íŒ…ë°©ì€ ì–´ë–¤ ê²ƒì´ê³ 

### ì¸ìƒì ì¸ ë‚´ìš©

### ì½”ë“œ

- app/chats/action.ts

```tsx
"use server";

import db from "@/lib/db";
import getSession from "@/lib/session";

export async function saveMessage(payload: string, chatRoomId: string) {
  const session = await getSession();
  await db.message.create({
    data: {
      payload,
      chatRoomId,
      userId: session.id!,
    },
    select: {
      id: true,
    },
  });
}
```

# 16 LIVE STREAMING

## 16.0 Introduction

### ì´ë²ˆì— í•  ê²ƒ

### ì¸ìƒì ì¸ ë‚´ìš©

- Cloudflare Stream
- íŠ¸ìœ„ì¹˜ ìœ íŠœë¸Œë¥¼ ë„ˆë¬´ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”
- https://developers.cloudflare.com/stream/stream-live
- $6 í•„ìš”

## 16.1 Live Input

### ì´ë²ˆì— í•  ê²ƒ

- Cloudflare stream ì‚¬ìš©
- OBS ìŠ¤íŠ¸ë¦¬ë° ì„œë¹„ìŠ¤

### ì¸ìƒì ì¸ ë‚´ìš©

https://developers.cloudflare.com/stream/get-started/

https://developers.cloudflare.com/stream/stream-live/start-stream-live/

### ì½”ë“œ

- app/streams/add/page.tsx

```tsx
"use client";

import Button from "@/components/button";
import Input from "@/components/input";
import { useFormState } from "react-dom";
import { startStream } from "./action";

export default function AddStream() {
  const [state, action] = useFormState(startStream, null);
  return (
    <form className="p-5 flex flex-col gap-2" action={action}>
      <Input
        name="title"
        required
        placeholder="Title or your stream."
        errors={state?.formErrors}
      />
      <Button text="Start streaming" />
    </form>
  );
}
```

- app/streams/add/action.ts

```tsx
"use server";

import db from "@/lib/db";
import getSession from "@/lib/session";
import { redirect } from "next/navigation";
import { z } from "zod";

const title = z.string();

export async function startStream(_: any, formData: FormData) {
  const results = title.safeParse(formData.get("title"));
  if (!results.success) {
    return results.error.flatten();
  }
  const response = await fetch(
    `https://api.cloudflare.com/client/v4/accounts/${process.env.CLOUDFLARE_ACCOUNT_ID}/stream/live_inputs`,
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.CLOUDFLARE_API_KEY}`,
      },
      body: JSON.stringify({
        meta: {
          name: results.data,
        },
        recording: {
          mode: "automatic",
        },
      }),
    }
  );
  const data = await response.json();
  const session = await getSession();
  const stream = await db.liveStream.create({
    data: {
      title: results.data,
      stream_id: data.result.uid,
      stream_key: data.result.rtmps.streamKey,
      userId: session.id!,
    },
    select: {
      id: true,
    },
  });
  redirect(`/streams/${stream.id}`);
}
```

## 16.2 Live Streaming

### ì´ë²ˆì— í•  ê²ƒ

- ë°©ì†¡ ìƒì„¸ í˜ì´ì§€

### ì¸ìƒì ì¸ ë‚´ìš©

- Tailwind CSS, aspect-video
- CloudflareëŠ” Stream URLê³¼ SecretKeyë¥¼ ì œê³µí•˜ê³  OBSë¥¼ ì‚¬ìš©í•´ì„œ ë°©ì†¡

### ì½”ë“œ

- app/streams/[id]/page.tsx

```tsx
import db from "@/lib/db";
import getSession from "@/lib/session";
import { UserIcon } from "@heroicons/react/24/solid";
import Image from "next/image";
import { notFound } from "next/navigation";

async function getStream(id: number) {
  const stream = await db.liveStream.findUnique({
    where: {
      id,
    },
    select: {
      title: true,
      stream_key: true,
      stream_id: true,
      userId: true,
      user: {
        select: {
          avatar: true,
          username: true,
        },
      },
    },
  });
  return stream;
}

export default async function StreamDetail({
  params,
}: {
  params: { id: string };
}) {
  const id = Number(params.id);
  if (isNaN(id)) {
    return notFound();
  }
  const stream = await getStream(id);
  if (!stream) {
    return notFound();
  }
  const session = await getSession();
  return (
    <div className="p-10">
      <div className="relative aspect-video">
        <iframe
          src={`https://${process.env.CLOUDFLARE_DOMAIN}/dc98714ad120275903d1c681fa987fbc/iframe`}
          allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
          className="w-full h-full rounded-md"
        ></iframe>
      </div>
      <div className="p-5 flex items-center gap-3 border-b border-neutral-700">
        <div className="size-10 overflow-hidden rounded-full">
          {stream.user.avatar !== null ? (
            <Image
              src={stream.user.avatar}
              width={40}
              height={40}
              alt={stream.user.username}
            />
          ) : (
            <UserIcon />
          )}
        </div>
        <div>
          <h3>{stream.user.username}</h3>
        </div>
      </div>
      <div className="p-5">
        <h1 className="text-2xl font-semibold">{stream.title}</h1>
      </div>
      {stream.userId === session.id! ? (
        <div className="bg-yellow-200 text-black p-5 rounded-md">
          <div className="flex gap-2">
            <span className="font-semibold">Stream URL:</span>
            <span>rtmps://live.cloudflare.com:443/live/</span>
          </div>
          <div className="flex  flex-wrap">
            <span className="font-semibold">Secret Key:</span>
            <span>{stream.stream_key}</span>
          </div>
        </div>
      ) : null}
    </div>
  );
}
```

# 17 NEXTJS EXTRAS

## 17.0 Introduction

### ì¸ìƒì ì¸ ë‚´ìš©

- ëª¨ë‘ ë‹¤ë¥¸ ë‚´ìš©ì„
- ë‹ˆì½”ëŠ” í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ë©´ í”„ë ˆì„ì›Œí¬ê°€ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ìµœëŒ€í•œ í™œìš©í•˜ë ¤ê³  ë…¸ë ¥í•¨

## 17.1 Fonts

### ì´ë²ˆì— í•  ê²ƒ

- êµ¬ê¸€ í°íŠ¸ ë¡œì»¬ í°íŠ¸

### ì¸ìƒì ì¸ ë‚´ìš©

https://nextjs.org/docs/app/building-your-application/optimizing/fonts

https://nextjs.org/docs/app/building-your-application/optimizing/fonts#with-tailwind-css

### ì½”ë“œ

- tailwind.config.ts

```tsx
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        roboto: "var(--roboto-text)",
        rubick: "var(--rubick-text)",
        metallica: "var(--metallica-text)",
      },
      margin: {
        tomato: "120px",
      },
      borderRadius: {
        "sexy-name": "11.11px",
      },
    },
  },
  plugins: [require("@tailwindcss/forms")],
};
export default config;
```

- app/layout.tsx

```tsx
import type { Metadata } from "next";
import { Roboto, Rubik_Scribble } from "next/font/google";
import localFont from "next/font/local";
import "./globals.css";

const roboto = Roboto({
  subsets: ["latin"],
  weight: ["400", "500"],
  style: ["normal"],
  variable: "--roboto-text",
});

const rubick = Rubik_Scribble({
  weight: "400",
  style: ["normal"],
  subsets: ["latin"],
  variable: "--rubick-text",
});

const metallica = localFont({
  src: "./metallica.ttf",
  variable: "--metallica-text",
});

export const metadata: Metadata = {
  title: {
    template: "%s | Karrot Market",
    default: "Karrot Market",
  },
  description: "Sell and buy all the things!",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${roboto.variable} ${rubick.variable} ${metallica.variable} bg-neutral-900 text-white max-w-screen-sm mx-auto`}
      >
        {children}
      </body>
    </html>
  );
}
```

- app/extras/page.tsx

```tsx
export default function Extras() {
  return (
    <div className="flex flex-col gap-3 py-10">
      <h1 className="text-6xl font-metallica">Extras!</h1>
      <h2 className="font-roboto">So much more to learn!</h2>
    </div>
  );
}
```

## 17.2 Private Folders

### ì´ë²ˆì— í•  ê²ƒ

- Private Folders

### íŒ

Private Folders

Private í´ë”ëŠ” í´ë” ì•ì— ë°‘ì¤„(\_folderName)ì„ ë¶™ì—¬ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

https://nextjs.org/docs/app/building-your-application/routing/colocation#private-folders
